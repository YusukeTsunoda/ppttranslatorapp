{"version":3,"sources":["/Users/yusuketsunoda/Documents/cursor/ppttranslatorapp/worktrees/feature-test-coverage-improvement/tests/api/download/route.test.ts"],"sourcesContent":["import { NextRequest } from 'next/server';\nimport { getServerSession } from 'next-auth';\nimport { promises as fs } from 'fs';\nimport { join } from 'path';\nimport { filePathManager } from '@/lib/utils/file-utils';\nimport { createMocks } from 'node-mocks-http';\nimport { GET } from '@/app/api/download/[userId]/[filename]/route';\n\n// モックの設定\njest.mock('next-auth', () => ({\n  getServerSession: jest.fn(),\n}));\n\njest.mock('fs', () => ({\n  promises: {\n    readFile: jest.fn(),\n    access: jest.fn(),\n  },\n}));\n\njest.mock('@/lib/utils/file-utils', () => ({\n  filePathManager: {\n    findActualFilePath: jest.fn(),\n  },\n  logFileOperation: jest.fn(),\n}));\n\n// モックの型定義\nconst mockGetServerSession = getServerSession as jest.Mock;\nconst mockReadFile = fs.readFile as jest.Mock;\nconst mockFindActualFilePath = filePathManager.findActualFilePath as jest.Mock;\n\ndescribe('/api/download/[userId]/[filename]', () => {\n  beforeEach(() => {\n    jest.clearAllMocks();\n  });\n\n  // テストユーザーの設定\n  const testUser = {\n    id: 'test-user-id',\n    name: 'Test User',\n    email: 'test@example.com',\n  };\n\n  // テストファイルの設定\n  const testFile = {\n    id: 'test-file-id',\n    name: 'test-file.pptx',\n    content: Buffer.from('test file content'),\n  };\n\n  it('未認証ユーザーのアクセスを拒否する', async () => {\n    // getServerSessionのモックを設定\n    mockGetServerSession.mockResolvedValue(null);\n\n    const { req } = createMocks({\n      method: 'GET',\n    });\n\n    const response = await GET(req as unknown as NextRequest, {\n      params: {\n        userId: testUser.id,\n        filename: testFile.name,\n      },\n    });\n\n    expect(response.status).toBe(401);\n    const data = await response.json();\n    expect(data.error).toBe('認証が必要です');\n  });\n\n  it('他のユーザーのファイルへのアクセスを拒否する', async () => {\n    // getServerSessionのモックを設定\n    mockGetServerSession.mockResolvedValue({\n      user: testUser,\n    });\n\n    const { req } = createMocks({\n      method: 'GET',\n    });\n\n    const response = await GET(req as unknown as NextRequest, {\n      params: {\n        userId: 'other-user-id',\n        filename: testFile.name,\n      },\n    });\n\n    expect(response.status).toBe(403);\n    const data = await response.json();\n    expect(data.error).toBe('アクセス権限がありません');\n  });\n\n  it('存在しないファイルへのアクセスを404で返す', async () => {\n    // getServerSessionのモックを設定\n    mockGetServerSession.mockResolvedValue({\n      user: testUser,\n    });\n\n    // filePathManagerのモックを設定\n    mockFindActualFilePath.mockResolvedValue(null);\n\n    const { req } = createMocks({\n      method: 'GET',\n    });\n\n    const response = await GET(req as unknown as NextRequest, {\n      params: {\n        userId: testUser.id,\n        filename: 'non-existent-file.pptx',\n      },\n    });\n\n    expect(response.status).toBe(404);\n    const data = await response.json();\n    expect(data.error).toBe('ファイルが見つかりません');\n  });\n\n  it('正常なファイルダウンロードを処理する', async () => {\n    // getServerSessionのモックを設定\n    mockGetServerSession.mockResolvedValue({\n      user: testUser,\n    });\n\n    // filePathManagerのモックを設定\n    const testFilePath = '/test/path/test-file.pptx';\n    mockFindActualFilePath.mockResolvedValue(testFilePath);\n\n    // fs.readFileのモックを設定\n    mockReadFile.mockResolvedValue(testFile.content);\n\n    const { req } = createMocks({\n      method: 'GET',\n    });\n\n    const response = await GET(req as unknown as NextRequest, {\n      params: {\n        userId: testUser.id,\n        filename: testFile.name,\n      },\n    });\n\n    expect(response.status).toBe(200);\n    expect(response.headers.get('Content-Type')).toBe(\n      'application/vnd.openxmlformats-officedocument.presentationml.presentation'\n    );\n    expect(response.headers.get('Content-Disposition')).toBe(\n      `attachment; filename=\"${testFile.name}\"`\n    );\n\n    const buffer = await response.arrayBuffer();\n    expect(Buffer.from(buffer)).toEqual(testFile.content);\n  });\n\n  it('ファイル読み込みエラーを処理する', async () => {\n    // getServerSessionのモックを設定\n    mockGetServerSession.mockResolvedValue({\n      user: testUser,\n    });\n\n    // filePathManagerのモックを設定\n    const testFilePath = '/test/path/test-file.pptx';\n    mockFindActualFilePath.mockResolvedValue(testFilePath);\n\n    // fs.readFileのモックを設定してエラーを投げる\n    mockReadFile.mockRejectedValue(new Error('ファイル読み込みエラー'));\n\n    const { req } = createMocks({\n      method: 'GET',\n    });\n\n    const response = await GET(req as unknown as NextRequest, {\n      params: {\n        userId: testUser.id,\n        filename: testFile.name,\n      },\n    });\n\n    expect(response.status).toBe(500);\n    const data = await response.json();\n    expect(data.error).toBe('ファイルのダウンロードに失敗しました');\n  });\n}); "],"names":["jest","mock","getServerSession","fn","promises","readFile","access","filePathManager","findActualFilePath","logFileOperation","mockGetServerSession","mockReadFile","fs","mockFindActualFilePath","describe","beforeEach","clearAllMocks","testUser","id","name","email","testFile","content","Buffer","from","it","mockResolvedValue","req","createMocks","method","response","GET","params","userId","filename","expect","status","toBe","data","json","error","user","testFilePath","headers","get","buffer","arrayBuffer","toEqual","mockRejectedValue","Error"],"mappings":"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"}