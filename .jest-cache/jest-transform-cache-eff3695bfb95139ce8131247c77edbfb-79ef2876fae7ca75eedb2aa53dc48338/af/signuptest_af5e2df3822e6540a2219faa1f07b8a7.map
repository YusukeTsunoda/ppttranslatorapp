{"version":3,"sources":["/Users/yusuketsunoda/Documents/cursor/ppttranslatorapp/worktrees/cicd-setup/tests/api/auth/signup.test.ts"],"sourcesContent":["import { POST } from '@/app/api/auth/signup/route';\nimport { NextRequest } from 'next/server';\nimport bcrypt from 'bcrypt';\n\n// PrismaClientのモック\nconst mockUserFindUnique = jest.fn();\nconst mockUserCreate = jest.fn();\nconst mockDisconnect = jest.fn();\n\n// PrismaClientのモック設定\njest.mock('@prisma/client', () => {\n  return {\n    PrismaClient: jest.fn().mockImplementation(() => {\n      return {\n        user: {\n          findUnique: mockUserFindUnique,\n          create: mockUserCreate,\n        },\n        $disconnect: mockDisconnect,\n      };\n    }),\n  };\n});\n\n// bcryptのモック設定\njest.mock('bcrypt', () => ({\n  hash: jest.fn(),\n}));\n\n// テスト用のモック関数\nconst bcryptHashMock = bcrypt.hash as jest.Mock;\n\ndescribe('Signup API', () => {\n  // prisma変数は不要になったため削除\n\n  beforeEach(() => {\n    jest.clearAllMocks();\n    bcryptHashMock.mockResolvedValue('hashed_password');\n    \n    // モックのリセット\n    mockUserFindUnique.mockReset();\n    mockUserCreate.mockReset();\n    mockDisconnect.mockReset();\n  });\n\n  describe('POST /api/auth/signup', () => {\n    it('正常なサインアップリクエストを処理できる', async () => {\n      // ユーザーが存在しない場合のモック設定\n      mockUserFindUnique.mockResolvedValue(null);\n      \n      // パスワードハッシュ化のモック\n      bcryptHashMock.mockResolvedValue('hashed_password');\n\n      // ユーザー作成のモック\n      mockUserCreate.mockResolvedValue({\n        id: 'test-user-id',\n        name: 'Test User',\n        email: 'test@example.com',\n        password: 'hashed_password',\n        credits: 100,\n        updatedAt: new Date(),\n        createdAt: new Date(),\n      });\n\n      const req = new Request('http://localhost:3000/api/auth/signup', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          name: 'Test User',\n          email: 'test@example.com',\n          password: 'password123',\n        }),\n      });\n\n      const response = await POST(req as unknown as NextRequest);\n      expect(response.status).toBe(201);\n\n      const data = await response.json();\n      expect(data.message).toBe('ユーザーが正常に作成されました');\n      expect(data.user).toEqual({\n        id: 'test-user-id',\n        name: 'Test User',\n        email: 'test@example.com',\n      });\n    });\n\n    it('必須フィールドが欠けている場合は400エラーを返す', async () => {\n      // 実際のAPIレスポンスに合わせて期待値を設定\n      const testCases = [\n        { \n          body: { email: 'test@example.com', password: 'password123' },\n          expectedError: 'Required'\n        },\n        { \n          body: { name: 'Test User', password: 'password123' },\n          expectedError: 'Required'\n        },\n        { \n          body: { name: 'Test User', email: 'test@example.com' },\n          expectedError: 'Required'\n        },\n      ];\n\n      for (const testCase of testCases) {\n        const req = new Request('http://localhost:3000/api/auth/signup', {\n          method: 'POST',\n          headers: {\n            'Content-Type': 'application/json',\n          },\n          body: JSON.stringify(testCase.body),\n        });\n\n        const response = await POST(req as unknown as NextRequest);\n        expect(response.status).toBe(400);\n\n        const data = await response.json();\n        expect(data.error).toBe(testCase.expectedError);\n      }\n    });\n\n    it('既存のメールアドレスの場合は400エラーを返す', async () => {\n      // ユーザーが既に存在する場合のモック設定\n      mockUserFindUnique.mockResolvedValue({\n        id: 'existing-user-id',\n        name: 'Existing User',\n        email: 'test@example.com',\n        password: 'hashed_password',\n        credits: 100,\n        updatedAt: new Date(),\n        createdAt: new Date(),\n      });\n\n      const req = new Request('http://localhost:3000/api/auth/signup', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          name: 'Test User',\n          email: 'test@example.com',\n          password: 'password123',\n        }),\n      });\n\n      const response = await POST(req as unknown as NextRequest);\n      expect(response.status).toBe(400);\n\n      const data = await response.json();\n      expect(data.error).toBe('このメールアドレスは既に登録されています');\n    });\n\n    it('パスワードが短すぎる場合は400エラーを返す', async () => {\n      const req = new Request('http://localhost:3000/api/auth/signup', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          name: 'Test User',\n          email: 'test@example.com',\n          password: '12345', // 6文字未満\n        }),\n      });\n\n      const response = await POST(req as unknown as NextRequest);\n      expect(response.status).toBe(400);\n\n      const data = await response.json();\n      expect(data.error).toBe('パスワードは6文字以上必要です');\n    });\n\n    it('メールアドレスの形式が不正な場合は400エラーを返す', async () => {\n      const req = new Request('http://localhost:3000/api/auth/signup', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          name: 'Test User',\n          email: 'invalid-email', // 不正なメールアドレス形式\n          password: 'password123',\n        }),\n      });\n\n      const response = await POST(req as unknown as NextRequest);\n      expect(response.status).toBe(400);\n\n      const data = await response.json();\n      expect(data.error).toBe('有効なメールアドレスを入力してください');\n    });\n\n    it('データベースエラーの場合は500エラーを返す', async () => {\n      // データベースエラーのモック設定\n      mockUserFindUnique.mockRejectedValue(new Error('Database error'));\n\n      const req = new Request('http://localhost:3000/api/auth/signup', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          name: 'Test User',\n          email: 'test@example.com',\n          password: 'password123',\n        }),\n      });\n\n      const response = await POST(req as unknown as NextRequest);\n      expect(response.status).toBe(500);\n\n      const data = await response.json();\n      expect(data.error).toBeTruthy();\n    });\n  });\n});"],"names":["jest","mock","PrismaClient","fn","mockImplementation","user","findUnique","mockUserFindUnique","create","mockUserCreate","$disconnect","mockDisconnect","hash","bcryptHashMock","bcrypt","describe","beforeEach","clearAllMocks","mockResolvedValue","mockReset","it","id","name","email","password","credits","updatedAt","Date","createdAt","req","Request","method","headers","body","JSON","stringify","response","POST","expect","status","toBe","data","json","message","toEqual","testCases","expectedError","testCase","error","mockRejectedValue","Error","toBeTruthy"],"mappings":"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"}