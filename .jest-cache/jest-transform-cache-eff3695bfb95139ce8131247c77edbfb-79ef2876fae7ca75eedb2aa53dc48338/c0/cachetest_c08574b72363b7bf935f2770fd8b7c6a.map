{"version":3,"sources":["/Users/yusuketsunoda/Documents/cursor/ppttranslatorapp/worktrees/cicd-setup/tests/lib/translation/cache.test.ts"],"sourcesContent":["import { describe, expect, it, jest, beforeEach } from '@jest/globals';\nimport { TranslationCache } from '@/lib/translation/cache';\n\ndescribe('Translation Cache', () => {\n  let cache: TranslationCache;\n\n  beforeEach(() => {\n    cache = new TranslationCache({\n      maxSize: 1000,\n      ttl: 3600, // 1時間\n    });\n  });\n\n  describe('基本的な操作', () => {\n    it('キャッシュに値を設定して取得する', () => {\n      const key = { text: 'Hello', sourceLang: 'en', targetLang: 'ja' };\n      const value = { translated: 'こんにちは', timestamp: Date.now() };\n\n      cache.set(key, value);\n      const cached = cache.get(key);\n\n      expect(cached).toEqual(value);\n    });\n\n    it('存在しないキーはnullを返す', () => {\n      const key = { text: 'Hello', sourceLang: 'en', targetLang: 'ja' };\n      const cached = cache.get(key);\n\n      expect(cached).toBeNull();\n    });\n\n    it('TTL経過後はキャッシュが無効になる', async () => {\n      const key = { text: 'Hello', sourceLang: 'en', targetLang: 'ja' };\n      const value = { translated: 'こんにちは', timestamp: Date.now() };\n\n      cache = new TranslationCache({ maxSize: 1000, ttl: 1 }); // TTLを1秒に設定\n      cache.set(key, value);\n\n      // TTLが経過するまで待機\n      await new Promise(resolve => setTimeout(resolve, 1100));\n\n      const cached = cache.get(key);\n      expect(cached).toBeNull();\n    });\n  });\n\n  describe('キャッシュサイズ制限', () => {\n    it('最大サイズを超えた場合は古いエントリを削除する', () => {\n      cache = new TranslationCache({ maxSize: 2, ttl: 3600 });\n\n      const keys = [\n        { text: 'Hello', sourceLang: 'en', targetLang: 'ja' },\n        { text: 'World', sourceLang: 'en', targetLang: 'ja' },\n        { text: 'Test', sourceLang: 'en', targetLang: 'ja' },\n      ];\n\n      keys.forEach((key, index) => {\n        cache.set(key, { translated: `Value ${index}`, timestamp: Date.now() });\n      });\n\n      // 最も古いエントリが削除されていることを確認\n      expect(cache.get(keys[0])).toBeNull();\n      expect(cache.get(keys[1])).not.toBeNull();\n      expect(cache.get(keys[2])).not.toBeNull();\n    });\n\n    it('キャッシュサイズを取得する', () => {\n      const keys = [\n        { text: 'Hello', sourceLang: 'en', targetLang: 'ja' },\n        { text: 'World', sourceLang: 'en', targetLang: 'ja' },\n      ];\n\n      keys.forEach((key, index) => {\n        cache.set(key, { translated: `Value ${index}`, timestamp: Date.now() });\n      });\n\n      expect(cache.size()).toBe(2);\n    });\n  });\n\n  describe('キャッシュ操作', () => {\n    it('キャッシュをクリアする', () => {\n      const key = { text: 'Hello', sourceLang: 'en', targetLang: 'ja' };\n      const value = { translated: 'こんにちは', timestamp: Date.now() };\n\n      cache.set(key, value);\n      expect(cache.size()).toBe(1);\n\n      cache.clear();\n      expect(cache.size()).toBe(0);\n      expect(cache.get(key)).toBeNull();\n    });\n\n    it('キャッシュから特定のエントリを削除する', () => {\n      const key = { text: 'Hello', sourceLang: 'en', targetLang: 'ja' };\n      const value = { translated: 'こんにちは', timestamp: Date.now() };\n\n      cache.set(key, value);\n      expect(cache.get(key)).not.toBeNull();\n\n      cache.delete(key);\n      expect(cache.get(key)).toBeNull();\n    });\n\n    it('キャッシュの統計情報を取得する', () => {\n      const keys = [\n        { text: 'Hello', sourceLang: 'en', targetLang: 'ja' },\n        { text: 'World', sourceLang: 'en', targetLang: 'ja' },\n      ];\n\n      keys.forEach((key, index) => {\n        cache.set(key, { translated: `Value ${index}`, timestamp: Date.now() });\n        cache.get(key); // ヒットカウントを増やす\n      });\n\n      const stats = cache.getStats();\n      expect(stats.size).toBe(2);\n      expect(stats.hits).toBe(2);\n      expect(stats.misses).toBe(0);\n    });\n  });\n\n  describe('キャッシュキーの生成', () => {\n    it('異なるテキストで異なるキーを生成する', () => {\n      const key1 = { text: 'Hello', sourceLang: 'en', targetLang: 'ja' };\n      const key2 = { text: 'World', sourceLang: 'en', targetLang: 'ja' };\n\n      cache.set(key1, { translated: 'こんにちは', timestamp: Date.now() });\n      cache.set(key2, { translated: '世界', timestamp: Date.now() });\n\n      expect(cache.get(key1)?.translated).toBe('こんにちは');\n      expect(cache.get(key2)?.translated).toBe('世界');\n    });\n\n    it('異なる言語ペアで異なるキーを生成する', () => {\n      const text = 'Hello';\n      const key1 = { text, sourceLang: 'en', targetLang: 'ja' };\n      const key2 = { text, sourceLang: 'en', targetLang: 'fr' };\n\n      cache.set(key1, { translated: 'こんにちは', timestamp: Date.now() });\n      cache.set(key2, { translated: 'Bonjour', timestamp: Date.now() });\n\n      expect(cache.get(key1)?.translated).toBe('こんにちは');\n      expect(cache.get(key2)?.translated).toBe('Bonjour');\n    });\n  });\n\n  describe('エラー処理', () => {\n    it('無効なTTL値でエラーをスローする', () => {\n      expect(() => {\n        new TranslationCache({ maxSize: 1000, ttl: -1 });\n      }).toThrow('TTL must be a positive number');\n    });\n\n    it('無効なキャッシュサイズでエラーをスローする', () => {\n      expect(() => {\n        new TranslationCache({ maxSize: 0, ttl: 3600 });\n      }).toThrow('Cache size must be a positive number');\n    });\n\n    it('無効なキャッシュキーでエラーをスローする', () => {\n      expect(() => {\n        cache.set({ text: '', sourceLang: 'en', targetLang: 'ja' }, { translated: 'test', timestamp: Date.now() });\n      }).toThrow('Invalid cache key');\n    });\n  });\n}); "],"names":["describe","cache","beforeEach","TranslationCache","maxSize","ttl","it","key","text","sourceLang","targetLang","value","translated","timestamp","Date","now","set","cached","get","expect","toEqual","toBeNull","Promise","resolve","setTimeout","keys","forEach","index","not","size","toBe","clear","delete","stats","getStats","hits","misses","key1","key2","toThrow"],"mappings":"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"}