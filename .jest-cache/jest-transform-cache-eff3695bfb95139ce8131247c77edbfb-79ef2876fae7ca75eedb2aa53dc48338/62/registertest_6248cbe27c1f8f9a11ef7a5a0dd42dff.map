{"version":3,"sources":["/Users/yusuketsunoda/Documents/cursor/ppttranslatorapp/worktrees/cicd-setup/tests/api/auth/register.test.ts"],"sourcesContent":["import { mockDeep, DeepMockProxy } from 'jest-mock-extended';\nimport { PrismaClient, UserRole } from '@prisma/client';\n\n// Prismaのモックを作成\nconst mockPrisma = mockDeep<PrismaClient>();\n\n// モジュールのモック化を先に行う\njest.mock('@/lib/db/prisma', () => ({\n  prisma: mockPrisma\n}));\n\njest.mock('@/lib/auth/password', () => ({\n  hashPassword: jest.fn(),\n}));\n\n// モック定義後にインポートする\nimport { POST } from '@/app/api/auth/register/route';\nimport { prisma } from '@/lib/db/prisma';\nimport { hashPassword } from '@/lib/auth/password';\nimport { createMockUser, clearAllMocks } from '@/tests/helpers/mockSetup';\n\n// Jestのexpect関数をモック化しないようにする\nconst actualExpect = global.expect;\nconst hashPasswordMock = hashPassword as jest.Mock;\n\ndescribe('POST /api/auth/register', () => {\n  beforeEach(() => {\n    clearAllMocks();\n    jest.clearAllMocks();\n    hashPasswordMock.mockResolvedValue('hashed_password');\n  });\n\n  it('should register a new user successfully', async () => {\n    const requestBody = {\n      email: 'test@example.com',\n      password: 'password123',\n      name: 'Test User',\n    };\n    const req = new Request('http://localhost/api/auth/register', {\n      method: 'POST',\n      body: JSON.stringify(requestBody),\n      headers: { 'Content-Type': 'application/json' },\n    });\n\n    mockPrisma.user.findUnique.mockResolvedValue(null);\n    const createdUser = createMockUser({\n      id: 'generated-uuid',\n      email: requestBody.email,\n      name: requestBody.name,\n      password: 'hashed_password',\n      credits: 15,\n      role: UserRole.USER,\n    });\n    mockPrisma.user.create.mockResolvedValue(createdUser);\n\n    const response = await POST(req as Request);\n    const responseBody = await response.json();\n\n    actualExpect(response.status).toBe(200);\n    actualExpect(responseBody.success).toBe(true);\n    actualExpect(responseBody.userId).toBe(createdUser.id);\n\n    actualExpect(mockPrisma.user.findUnique).toHaveBeenCalledWith({\n      where: { email: requestBody.email },\n    });\n    actualExpect(hashPasswordMock).toHaveBeenCalledWith(requestBody.password);\n    actualExpect(mockPrisma.user.create).toHaveBeenCalledWith(\n      actualExpect.objectContaining({\n        data: actualExpect.objectContaining({\n          email: requestBody.email,\n          name: requestBody.name,\n          password: 'hashed_password',\n          credits: 15,\n        }),\n      })\n    );\n  });\n\n  it('should return 400 if email already exists', async () => {\n    const requestBody = {\n      email: 'existing@example.com',\n      password: 'password123',\n      name: 'Existing User',\n    };\n    const req = new Request('http://localhost/api/auth/register', {\n      method: 'POST',\n      body: JSON.stringify(requestBody),\n      headers: { 'Content-Type': 'application/json' },\n    });\n\n    mockPrisma.user.findUnique.mockResolvedValue(createMockUser({\n      email: requestBody.email,\n      name: requestBody.name,\n    }));\n\n    const response = await POST(req as Request);\n    const responseBody = await response.json();\n\n    actualExpect(response.status).toBe(400);\n    actualExpect(responseBody.error).toBe('このメールアドレスは既に登録されています');\n    actualExpect(mockPrisma.user.create).not.toHaveBeenCalled();\n  });\n\n  it('should return 500 if hashing password fails', async () => {\n    const requestBody = {\n      email: 'test2@example.com',\n      password: 'password123',\n      name: 'Test User 2',\n    };\n    const req = new Request('http://localhost/api/auth/register', {\n      method: 'POST',\n      body: JSON.stringify(requestBody),\n      headers: { 'Content-Type': 'application/json' },\n    });\n\n    mockPrisma.user.findUnique.mockResolvedValue(null);\n    hashPasswordMock.mockRejectedValue(new Error('Hashing failed'));\n\n    const response = await POST(req as Request);\n    const responseBody = await response.json();\n\n    actualExpect(response.status).toBe(500);\n    actualExpect(responseBody.error).toBe('ユーザー登録中にエラーが発生しました');\n    actualExpect(mockPrisma.user.create).not.toHaveBeenCalled();\n  });\n\n  it('should return 500 if creating user fails', async () => {\n    const requestBody = {\n      email: 'test3@example.com',\n      password: 'password123',\n      name: 'Test User 3',\n    };\n    const req = new Request('http://localhost/api/auth/register', {\n      method: 'POST',\n      body: JSON.stringify(requestBody),\n      headers: { 'Content-Type': 'application/json' },\n    });\n\n    mockPrisma.user.findUnique.mockResolvedValue(null);\n    hashPasswordMock.mockResolvedValue('hashed_password_for_test3');\n    mockPrisma.user.create.mockRejectedValue(new Error('DB error'));\n\n    const response = await POST(req as Request);\n    const responseBody = await response.json();\n\n    actualExpect(response.status).toBe(500);\n    actualExpect(responseBody.error).toBe('ユーザー登録中にエラーが発生しました');\n  });\n\n  // TODO: リクエストボディのバリデーションに関するテストケースを追加\n  // (例: email, password, name が欠落している場合など。現状のAPIは自前でバリデーションしていないため、\n  //  NextRequestの挙動や、将来的なバリデーションライブラリ導入時にテスト追加を検討)\n}); "],"names":["jest","mock","prisma","mockPrisma","hashPassword","fn","mockDeep","actualExpect","global","expect","hashPasswordMock","describe","beforeEach","clearAllMocks","mockResolvedValue","it","requestBody","email","password","name","req","Request","method","body","JSON","stringify","headers","user","findUnique","createdUser","createMockUser","id","credits","role","UserRole","USER","create","response","POST","responseBody","json","status","toBe","success","userId","toHaveBeenCalledWith","where","objectContaining","data","error","not","toHaveBeenCalled","mockRejectedValue","Error"],"mappings":"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"}