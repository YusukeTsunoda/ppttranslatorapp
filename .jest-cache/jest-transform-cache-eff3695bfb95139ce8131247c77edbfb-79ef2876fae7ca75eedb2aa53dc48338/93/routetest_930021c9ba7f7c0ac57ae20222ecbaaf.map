{"version":3,"sources":["/Users/yusuketsunoda/Documents/cursor/ppttranslatorapp/worktrees/cicd-setup/tests/api/download/route.test.ts"],"sourcesContent":["// モックの設定\njest.mock('next-auth', () => ({\n  getServerSession: jest.fn(),\n}));\n\njest.mock('fs', () => ({\n  promises: {\n    readFile: jest.fn(),\n    access: jest.fn(),\n  },\n}));\n\njest.mock('@/lib/utils/file-utils', () => ({\n  filePathManager: {\n    findActualFilePath: jest.fn(),\n    getAbsolutePath: jest.fn((path) => path),\n  },\n  logFileOperation: jest.fn(),\n}));\n\nimport { NextRequest } from 'next/server';\nimport { getServerSession } from 'next-auth';\nimport { promises as fs } from 'fs';\nimport { filePathManager, logFileOperation } from '@/lib/utils/file-utils';\nimport { createMocks } from 'node-mocks-http';\nimport { GET } from '@/app/api/download/[userId]/[filename]/route';\n\ndescribe('/api/download/[userId]/[filename]', () => {\n  beforeEach(() => {\n    jest.clearAllMocks();\n  });\n\n  // テストユーザーの設定\n  const testUser = {\n    id: 'test-user-id',\n    name: 'Test User',\n    email: 'test@example.com',\n  };\n\n  // テストファイルの設定\n  const testFile = {\n    id: 'test-file-id',\n    name: 'test-file.pptx',\n    content: Buffer.from('test file content'),\n  };\n\n  it('未認証ユーザーのアクセスを拒否する', async () => {\n    // getServerSessionのモックを設定\n    (getServerSession as jest.Mock).mockResolvedValue(null);\n\n    const { req } = createMocks({\n      method: 'GET',\n    });\n\n    const response = await GET(req as unknown as NextRequest, {\n      params: {\n        userId: testUser.id,\n        filename: testFile.name,\n      },\n    });\n\n    expect(response.status).toBe(401);\n    const data = await response.json();\n    expect(data.error).toBe('認証が必要です');\n  });\n\n  it('他のユーザーのファイルへのアクセスを拒否する', async () => {\n    // getServerSessionのモックを設定\n    (getServerSession as jest.Mock).mockResolvedValue({\n      user: testUser,\n    });\n\n    const { req } = createMocks({\n      method: 'GET',\n    });\n\n    const response = await GET(req as unknown as NextRequest, {\n      params: {\n        userId: 'other-user-id',\n        filename: testFile.name,\n      },\n    });\n\n    expect(response.status).toBe(403);\n    const data = await response.json();\n    expect(data.error).toBe('アクセス権限がありません');\n  });\n\n  it('存在しないファイルへのアクセスを404で返す', async () => {\n    // getServerSessionのモックを設定\n    (getServerSession as jest.Mock).mockResolvedValue({\n      user: testUser,\n    });\n\n    // filePathManagerのモックを設定\n    (filePathManager.findActualFilePath as jest.Mock).mockResolvedValue(null);\n\n    const { req } = createMocks({\n      method: 'GET',\n    });\n\n    const response = await GET(req as unknown as NextRequest, {\n      params: {\n        userId: testUser.id,\n        filename: 'non-existent-file.pptx',\n      },\n    });\n\n    expect(response.status).toBe(404);\n    const data = await response.json();\n    expect(data.error).toBe('ファイルが見つかりません');\n  });\n\n  it('正常なファイルダウンロードを処理する', async () => {\n    // getServerSessionのモックを設定\n    (getServerSession as jest.Mock).mockResolvedValue({\n      user: testUser,\n    });\n\n    // filePathManagerのモックを設定\n    const testFilePath = '/test/path/test-file.pptx';\n    (filePathManager.findActualFilePath as jest.Mock).mockResolvedValue(testFilePath);\n    (filePathManager.getAbsolutePath as jest.Mock).mockReturnValue(testFilePath);\n\n    // fs.readFileのモックを設定\n    (fs.readFile as jest.Mock).mockResolvedValue(testFile.content);\n\n    const { req } = createMocks({\n      method: 'GET',\n    });\n\n    const response = await GET(req as unknown as NextRequest, {\n      params: {\n        userId: testUser.id,\n        filename: testFile.name,\n      },\n    });\n\n    expect(response.status).toBe(200);\n    expect(response.headers.get('Content-Type')).toBe(\n      'application/vnd.openxmlformats-officedocument.presentationml.presentation'\n    );\n    expect(response.headers.get('Content-Disposition')).toBe(\n      `attachment; filename=\"${testFile.name}\"`\n    );\n\n    const buffer = await response.arrayBuffer();\n    expect(Buffer.from(buffer)).toEqual(testFile.content);\n\n    // logFileOperationが呼び出されたことを確認\n    expect(logFileOperation).toHaveBeenCalledWith(testUser.id, 'access', testFile.id, true);\n  });\n\n  it('ファイル読み込みエラーを処理する', async () => {\n    // getServerSessionのモックを設定\n    (getServerSession as jest.Mock).mockResolvedValue({\n      user: testUser,\n    });\n\n    // filePathManagerのモックを設定\n    const testFilePath = '/test/path/test-file.pptx';\n    (filePathManager.findActualFilePath as jest.Mock).mockResolvedValue(testFilePath);\n    (filePathManager.getAbsolutePath as jest.Mock).mockReturnValue(testFilePath);\n\n    // fs.readFileのモックを設定してエラーを投げる\n    const testError = new Error('ファイル読み込みエラー');\n    (fs.readFile as jest.Mock).mockRejectedValue(testError);\n\n    const { req } = createMocks({\n      method: 'GET',\n    });\n\n    const response = await GET(req as unknown as NextRequest, {\n      params: {\n        userId: testUser.id,\n        filename: testFile.name,\n      },\n    });\n\n    expect(response.status).toBe(500);\n    const data = await response.json();\n    expect(data.error).toBe('ファイルのダウンロードに失敗しました');\n    expect(data.details).toBe('ファイル読み込みエラー');\n\n    // logFileOperationがエラーで呼び出されたことを確認\n    expect(logFileOperation).toHaveBeenCalledWith(testUser.id, 'access', testFile.id, false, testError.message);\n  });\n}); "],"names":["jest","mock","getServerSession","fn","promises","readFile","access","filePathManager","findActualFilePath","getAbsolutePath","path","logFileOperation","describe","beforeEach","clearAllMocks","testUser","id","name","email","testFile","content","Buffer","from","it","mockResolvedValue","req","createMocks","method","response","GET","params","userId","filename","expect","status","toBe","data","json","error","user","testFilePath","mockReturnValue","fs","headers","get","buffer","arrayBuffer","toEqual","toHaveBeenCalledWith","testError","Error","mockRejectedValue","details","message"],"mappings":"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"}