{"version":3,"sources":["/Users/yusuketsunoda/Documents/cursor/ppttranslatorapp/worktrees/cicd-setup/tests/api/auth/reset-password/route.test.ts"],"sourcesContent":["import { POST } from '@/app/api/auth/reset-password/route';\nimport { generateResetToken } from '@/lib/auth/token';\nimport { sendPasswordResetEmail } from '@/lib/email/send';\nimport { createPrismaMock, createMockUser, clearAllMocks } from '@/tests/helpers/mockSetup';\nimport { UserRole } from '@prisma/client';\n\n// Jestのexpect関数をモック化しないようにする\nconst actualExpect = global.expect;\n\n// Token 生成関数のモック\njest.mock('@/lib/auth/token', () => ({\n  generateResetToken: jest.fn(),\n}));\n\n// メール送信関数のモック\njest.mock('@/lib/email/send', () => ({\n  sendPasswordResetEmail: jest.fn(),\n}));\n\nconst prismaMock = createPrismaMock();\nconst generateResetTokenMock = generateResetToken as jest.Mock;\nconst sendPasswordResetEmailMock = sendPasswordResetEmail as jest.Mock;\n\nconst originalEnv = process.env;\n\ndescribe('POST /api/auth/reset-password', () => {\n  beforeEach(() => {\n    jest.resetModules();\n    process.env = { ...originalEnv };\n    clearAllMocks();\n    generateResetTokenMock.mockResolvedValue('mocked-reset-token');\n    sendPasswordResetEmailMock.mockResolvedValue(undefined);\n    process.env.RESEND_API_KEY = 'test-resend-api-key';\n  });\n\n  afterAll(() => {\n    process.env = originalEnv;\n  });\n\n  it('should return success true when user exists and email is sent', async () => {\n    const requestBody = { email: 'user@example.com' };\n    const req = new Request('http://localhost/api/auth/reset-password', {\n      method: 'POST',\n      body: JSON.stringify(requestBody),\n      headers: { 'Content-Type': 'application/json' },\n    });\n\n    const mockUser = createMockUser({\n      id: 'user-id',\n      email: requestBody.email,\n      name: 'Test User',\n      credits: 10,\n      role: UserRole.USER,\n    });\n    prismaMock.user.findUnique.mockResolvedValue(mockUser);\n    prismaMock.user.update.mockResolvedValue(mockUser);\n\n    const response = await POST(req as Request);\n    const responseBody = await response.json();\n\n    actualExpect(response.status).toBe(200);\n    actualExpect(responseBody.success).toBe(true);\n    actualExpect(prismaMock.user.findUnique).toHaveBeenCalledWith({ where: { email: requestBody.email } });\n    actualExpect(generateResetTokenMock).toHaveBeenCalled();\n    actualExpect(prismaMock.user.update).toHaveBeenCalledWith({\n      where: { id: mockUser.id },\n      data: {\n        updatedAt: actualExpect.any(Date),\n      },\n    });\n    actualExpect(sendPasswordResetEmailMock).toHaveBeenCalledWith(requestBody.email, 'mocked-reset-token');\n  });\n\n  it('should return success true even if user does not exist (security measure)', async () => {\n    const requestBody = { email: 'nonexistent@example.com' };\n    const req = new Request('http://localhost/api/auth/reset-password', {\n      method: 'POST',\n      body: JSON.stringify(requestBody),\n      headers: { 'Content-Type': 'application/json' },\n    });\n\n    prismaMock.user.findUnique.mockResolvedValue(null);\n\n    const response = await POST(req as Request);\n    const responseBody = await response.json();\n\n    actualExpect(response.status).toBe(200);\n    actualExpect(responseBody.success).toBe(true);\n    actualExpect(generateResetTokenMock).not.toHaveBeenCalled();\n    actualExpect(prismaMock.user.update).not.toHaveBeenCalled();\n    actualExpect(sendPasswordResetEmailMock).not.toHaveBeenCalled();\n  });\n\n  it('should return 400 for invalid email format', async () => {\n    const requestBody = { email: 'invalid-email' };\n    const req = new Request('http://localhost/api/auth/reset-password', {\n      method: 'POST',\n      body: JSON.stringify(requestBody),\n      headers: { 'Content-Type': 'application/json' },\n    });\n\n    const response = await POST(req as Request);\n    const responseBody = await response.json();\n\n    actualExpect(response.status).toBe(500); // zodのparseエラーは現状500になるが、将来的には400にしたい\n    // expect(responseBody.error).toContain('Invalid email'); // zodのエラーメッセージを確認\n    actualExpect(responseBody.error).toBe('パスワードリセットの要求に失敗しました'); // 現状は汎用エラー\n  });\n\n  it('should return 500 if RESEND_API_KEY is not set', async () => {\n    delete process.env.RESEND_API_KEY; // 環境変数を削除\n    const requestBody = { email: 'user@example.com' };\n    const req = new Request('http://localhost/api/auth/reset-password', {\n      method: 'POST',\n      body: JSON.stringify(requestBody),\n      headers: { 'Content-Type': 'application/json' },\n    });\n\n    const response = await POST(req as Request);\n    const responseBody = await response.json();\n\n    actualExpect(response.status).toBe(500);\n    actualExpect(responseBody.error).toBe('Email service configuration error');\n  });\n\n  it('should return 500 if generateResetToken fails', async () => {\n    const requestBody = { email: 'user@example.com' };\n    const req = new Request('http://localhost/api/auth/reset-password', {\n      method: 'POST',\n      body: JSON.stringify(requestBody),\n      headers: { 'Content-Type': 'application/json' },\n    });\n    const mockUser = createMockUser({ id: 'user-id' });\n    prismaMock.user.findUnique.mockResolvedValue(mockUser);\n    generateResetTokenMock.mockRejectedValue(new Error('Token generation failed'));\n\n    const response = await POST(req as Request);\n    const responseBody = await response.json();\n\n    actualExpect(response.status).toBe(500);\n    actualExpect(responseBody.error).toBe('パスワードリセットの要求に失敗しました');\n  });\n\n  it('should return 500 if sendPasswordResetEmail fails', async () => {\n    const requestBody = { email: 'user@example.com' };\n    const req = new Request('http://localhost/api/auth/reset-password', {\n      method: 'POST',\n      body: JSON.stringify(requestBody),\n      headers: { 'Content-Type': 'application/json' },\n    });\n    const mockUser = createMockUser({ id: 'user-id' });\n    prismaMock.user.findUnique.mockResolvedValue(mockUser);\n    prismaMock.user.update.mockResolvedValue(mockUser);\n    sendPasswordResetEmailMock.mockRejectedValue(new Error('Email sending failed'));\n\n    const response = await POST(req as Request);\n    const responseBody = await response.json();\n\n    actualExpect(response.status).toBe(500);\n    actualExpect(responseBody.error).toBe('パスワードリセットの要求に失敗しました');\n  });\n\n  it('should return 500 if prisma.user.update fails', async () => {\n    const requestBody = { email: 'user@example.com' };\n    const req = new Request('http://localhost/api/auth/reset-password', {\n      method: 'POST',\n      body: JSON.stringify(requestBody),\n      headers: { 'Content-Type': 'application/json' },\n    });\n    const mockUser = createMockUser({ id: 'user-id' });\n    prismaMock.user.findUnique.mockResolvedValue(mockUser);\n    prismaMock.user.update.mockRejectedValue(new Error('DB update failed'));\n\n    const response = await POST(req as Request);\n    const responseBody = await response.json();\n\n    actualExpect(response.status).toBe(500);\n    actualExpect(responseBody.error).toBe('パスワードリセットの要求に失敗しました');\n  });\n}); "],"names":["jest","mock","generateResetToken","fn","sendPasswordResetEmail","actualExpect","global","expect","prismaMock","createPrismaMock","generateResetTokenMock","sendPasswordResetEmailMock","originalEnv","process","env","describe","beforeEach","resetModules","clearAllMocks","mockResolvedValue","undefined","RESEND_API_KEY","afterAll","it","requestBody","email","req","Request","method","body","JSON","stringify","headers","mockUser","createMockUser","id","name","credits","role","UserRole","USER","user","findUnique","update","response","POST","responseBody","json","status","toBe","success","toHaveBeenCalledWith","where","toHaveBeenCalled","data","updatedAt","any","Date","not","error","mockRejectedValue","Error"],"mappings":"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"}