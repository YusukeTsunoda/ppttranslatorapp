# MVPに必要な実装項目（実装順序と詳細）
mvp_required_implementation:
  title: MVPに必要な実装項目（実装順序と詳細）
  description: 優先度順に実装すべき項目と、各項目の詳細な実装ステップ
  items:
    - description: "- [ ] 5. スライドAPIの改善"
      priority: high
      phases:
        - phase_name: "現状分析"
          tasks:
            - description: "- [x] 現在のAPIの問題点と制限の特定" #完了
            - description: "- [x] パフォーマンスボトルネックの検出" #完了
            - description: "- [x] 認証関連の問題調査" #完了
            - description: "- [x] ファイルパス構造の一貫性確認" #完了
        - phase_name: "APIリファクタリング"
          tasks:
            - description: "- [x] エンドポイント設計の見直し" #完了
            - description: "- [x] レスポンス形式の最適化" #完了
            - description: "- [x] エラーハンドリングの強化" #完了
            - description: "- [x] パス構造の統一（/api/slides/{fileId}/slides/{imageName}形式）" #完了
            - description: "- [x] 認証処理の改善（credentials: 'include'の追加）" #完了
            - description: "- [x] CORSヘッダーの適切な設定" #完了
            - description: "- [x] ドキュメント整備" #完了
        - phase_name: "ドキュメント整備"
          tasks:
            - description: "- [x] API仕様書の更新" #完了
            - description: "- [x] 使用例の追加" #完了
            - description: "- [x] 新旧パス形式の移行ガイド作成" #完了
            
    - id: slide_api_refactor
      description: "PPTX スライド操作 API のレスポンス改善"
      priority: medium_high
      depends_on: [test_automation]
      phases:
        - phase_name: "現状分析"
          tasks:
            - "エンドポイントごとの TPS・P95 レイテンシ計測" #完了
            - "エラーログの多いパスを特定" #完了
            - "認証関連の問題調査（セッション情報のログ出力）" #完了
            - "ファイルパス構造の一貫性確認" #完了
        - phase_name: "API リファクタリング"
          tasks:
            - "REST → RPC で重複コールを削減" #完了
            - "スキーマバリデーション (zod) 導入" #完了
            - "共通エラーフォーマット整備" #完了
            - "パス構造の統一（/api/slides/{fileId}/slides/{imageName}形式）" #完了
            - "後方互換性のためのリダイレクト実装" #完了
            - "認証処理の改善（credentials: 'include'の追加）" #完了
            - "CORSヘッダーの適切な設定（Access-Control-Allow-Credentials: true）" #完了
        - phase_name: "ドキュメント整備"
          tasks:
            - "OpenAPI 仕様自動生成" #完了
            - "コードサンプル追加" #完了
            - "新旧パス形式の移行ガイド作成" #完了
      acceptance_criteria:
        - "P95 レイテンシ 200 ms → 80 ms 以下"
        - "400/500 系エラー率 1/1000 req 未満"
        - "認証エラーの発生率 0.1% 未満"

# 実装手順と注意点
implementation_details:
  title: スライドAPIの詳細実装手順と注意点
  description: スライドAPIの改善における詳細な実装手順、注意点、考慮すべき項目
  steps:
    - step: 1
      name: "ファイルパス構造の統一" #完了
      tasks:
        - "旧形式: `/tmp/users/{userId}/slides/{fileId}` から新形式: `/tmp/users/{userId}/{fileId}/slides` への移行" #完了
        - "APIエンドポイントのパス形式を `/api/slides/{fileId}/slides/{imageName}` に統一" #完了
        - "既存データの移行スクリプト作成と検証" #完了
      considerations:
        - "既存のファイルパスを使用している箇所の特定と修正"
        - "移行中のダウンタイムの最小化"
        - "エラー発生時のロールバック手順の準備"
      validation:
        - "全てのAPIエンドポイントで新しいパス形式が正しく解析されることを確認"
        - "既存のファイルが新しいパス構造で正しくアクセスできることを確認"
    
    - step: 2
      name: "認証処理の改善" #完了
      tasks:
        - "フロントエンドのfetchリクエストに`credentials: 'include'`を追加" #完了
        - "画像タグに`crossOrigin=\"anonymous\"`属性を追加" #完了
        - "APIレスポンスに`Access-Control-Allow-Credentials: true`ヘッダーを追加" #完了
        - "セッション情報のログ出力機能の実装" #完了
      considerations:
        - "ブラウザのセキュリティポリシーとの互換性確保"
        - "認証情報の適切な処理と保護"
        - "クロスオリジンリクエストの適切な処理"
      validation:
        - "ログイン状態でスライド画像が正しく表示されることを確認"
        - "認証エラーが発生しないことを確認"
        - "セッション情報が正しくログに出力されることを確認"
    
    - step: 3
      name: "後方互換性の確保" #完了
      tasks:
        - "旧形式のパス `/api/slides/{fileId}/{imageName}` へのリクエストを処理するリダイレクトハンドラの実装" #完了
        - "リダイレクト時のHTTPステータスコードとヘッダーの適切な設定" #完了
        - "デバッグログの追加によるパスパラメータ解析結果の詳細出力" #完了
      considerations:
        - "リダイレクトによるパフォーマンスへの影響の最小化"
        - "リダイレクトループの防止"
        - "適切なHTTPステータスコード（307 Temporary Redirect）の使用"
      validation:
        - "旧形式のパスへのリクエストが新形式に正しくリダイレクトされることを確認"
        - "リダイレクト後も認証情報が保持されることを確認"
    
    - step: 4
      name: "エラーハンドリングの強化" #完了
      tasks:
        - "無効なパス形式の場合の明確なエラーメッセージの実装" #完了
        - "パスの検証強化（2番目のパスセグメントが 'slides' であることの確認）" #完了
        - "詳細なエラー情報のログ出力機能の実装" #完了
      considerations:
        - "ユーザーフレンドリーなエラーメッセージの提供"
        - "セキュリティ情報の漏洩防止"
        - "デバッグ情報の適切なログレベルでの出力"
      validation:
        - "無効なパス形式でリクエストした場合に適切なエラーレスポンスが返されることを確認"
        - "エラー情報が適切にログに出力されることを確認"
    
    - step: 5
      name: "パフォーマンス最適化"
      tasks:
        - "画像キャッシュの実装または改善"
        - "レスポンスの圧縮設定の最適化"
        - "不要なミドルウェアの削除または最適化"
      considerations:
        - "キャッシュの有効期間と無効化戦略"
        - "ブラウザキャッシュとの連携"
        - "帯域幅使用量の最適化"
      validation:
        - "レスポンス時間の計測と目標値（P95 80ms以下）の達成確認"
        - "キャッシュヒット率の計測と最適化"
    
    - step: 6
      name: "テストとドキュメント整備"
      tasks:
        - "単体テストの作成と実行"
        - "統合テストの作成と実行"
        - "API仕様書の更新"
        - "使用例とサンプルコードの追加"
      considerations:
        - "エッジケースのテスト（無効なパス、大きな画像、認証エラーなど）"
        - "テスト環境と本番環境の差異の最小化"
        - "ドキュメントの正確性と完全性の確保"
      validation:
        - "全てのテストが成功することを確認"
        - "ドキュメントが最新の実装を正確に反映していることを確認"

# 実装時の注意事項
implementation_warnings:
  title: 実装時の注意事項
  description: スライドAPIの改善実装時に特に注意すべき項目
  warnings:
    - category: "パス構造"
      items:
        - "パスパラメータの解析ロジックを慎重に実装し、エッジケースを考慮すること"
        - "ファイルパスとURLパスの違いを明確に区別し、混同しないこと"
        - "パス内の特殊文字（スペース、非ASCII文字など）の適切なエンコード/デコードを確保すること"
    
    - category: "認証"
      items:
        - "認証情報の処理において、セキュリティリスクを最小化すること"
        - "CORSの設定は必要最小限に留め、不要なオリジンからのアクセスを許可しないこと"
        - "認証情報を含むリクエストのキャッシュ設定に注意すること"
    
    - category: "後方互換性"
      items:
        - "リダイレクト実装後も既存のクライアントが正常に動作することを確認すること"
        - "リダイレクトによるパフォーマンス低下を監視し、必要に応じて最適化すること"
        - "リダイレクトの段階的な廃止計画を検討すること"
    
    - category: "エラーハンドリング"
      items:
        - "セキュリティ上の理由から、詳細なエラー情報は内部ログにのみ出力し、クライアントには必要最小限の情報のみを返すこと"
        - "エラーメッセージは多言語対応を考慮すること"
        - "エラー発生時のフォールバックメカニズムを実装すること"
    
    - category: "パフォーマンス"
      items:
        - "大量のリクエストが発生した場合のスケーリング戦略を検討すること"
        - "画像サイズの最適化を検討すること"
        - "不要なリクエストを減らすためのクライアント側の最適化も検討すること"
    
    - category: "テスト"
      items:
        - "実際のユーザー環境を模擬したエンドツーエンドテストを実施すること"
        - "異なるブラウザでの動作確認を行うこと"
        - "モバイルデバイスでの動作確認も行うこと"