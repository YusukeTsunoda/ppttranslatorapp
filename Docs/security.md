# セキュリティ対策

## 目次

1. [認証・認可](#認証認可)
2. [データ保護](#データ保護)
3. [通信セキュリティ](#通信セキュリティ)
4. [インフラストラクチャセキュリティ](#インフラストラクチャセキュリティ)
5. [セッション管理](#セッション管理)
6. [脆弱性対策](#脆弱性対策)
7. [監査とログ](#監査とログ)
8. [トラブルシューティング](#トラブルシューティング)

## 認証・認可
- **JWTベースの認証システム**
  - アクセストークンと更新トークンの分離
  - トークンの有効期限設定（アクセストークン: 15分、更新トークン: 7日）
  - トークンローテーション戦略の実装
- **多要素認証（MFA）**
  - メール/SMS認証コード
  - TOTP（Time-based One-Time Password）対応
  - WebAuthn/FIDO2対応（予定）
- **OAuth 2.0 / OIDC連携**
  - Google, Microsoft, GitHubなどの主要プロバイダ対応
  - 適切なスコープ設定とクレーム検証
- **RBAC（ロールベースアクセス制御）**
  - 細粒度の権限設定（閲覧、編集、管理など）
  - チームベースのアクセス制御
  - リソースごとの権限管理

## データ保護
- **転送時の暗号化**
  - TLS 1.3の強制
  - 強力な暗号スイートの使用
  - HSTS（HTTP Strict Transport Security）の実装
- **保存データの暗号化**
  - AES-256-GCMによるデータベース暗号化
  - 暗号化キーのローテーション
  - 機密データの分離保存
- **ファイルセキュリティ**
  - アップロードファイルのウイルススキャン
  - ファイルタイプの検証
  - ファイルサイズの制限
  - 安全なストレージ設定
- **個人情報保護**
  - GDPRコンプライアンス
  - データ最小化原則の適用
  - データ保持ポリシーの実装
  - データ削除メカニズム

## 通信セキュリティ
- **HTTPS強制**
  - 全通信のTLS暗号化
  - 証明書の自動更新
  - 強力な暗号スイートの使用
- **HTTPセキュリティヘッダ**
  - Content-Security-Policy
  - X-Content-Type-Options
  - X-Frame-Options
  - Referrer-Policy
- **API保護**
  - レート制限
  - トークンベースの認証
  - IPアドレスフィルタリング
- **WebSocketセキュリティ**
  - 認証済みコネクションのみ許可
  - メッセージ検証
  - 暗号化通信

## インフラストラクチャセキュリティ
- **クラウドセキュリティ**
  - 最小権限の原則
  - ネットワークセグメンテーション
  - セキュリティグループの適切な設定
  - 定期的なセキュリティ評価
- **コンテナセキュリティ**
  - イメージの脆弱性スキャン
  - 不変インフラストラクチャ
  - ランタイム保護
- **ネットワークセキュリティ**
  - ファイアウォール設定
  - DDoS保護
  - 異常検知
- **モニタリングとアラート**
  - リアルタイムセキュリティモニタリング
  - 異常検知と自動アラート
  - インシデント対応プロセス

## セッション管理

### セッションの仕組み

セッション管理は、NextAuth.jsを使用したJWTベースの認証システムで実装されています。セッションのライフサイクルは以下の通りです：

1. **セッション開始**：
   - ユーザーがログインすると、JWTトークンが生成されます。
   - トークンには、ユーザーID、ロール、有効期限、ユーザーエージェント情報などが含まれます。
   - トークンはHTTP Cookieとして保存されます。

2. **セッション保存**：
   - セッショントークンは、HTTPOnly、Secure、SameSite=Laxの属性を持つCookieとして保存されます。
   - 開発環境では、HTTPSが利用できない場合があるため、Secure属性は環境に応じて設定されます。

3. **セッション検証**：
   - 各リクエストごとに、トークンの有効性が検証されます。
   - トークンの有効期限、署名、ユーザーエージェントが検証されます。
   - トークンが無効な場合、ユーザーは認証ページにリダイレクトされます。

4. **セッション終了**：
   - ユーザーがログアウトすると、セッショントークンが無効化されます。
   - セッションCookieが削除されます。
   - アクティビティログにログアウトイベントが記録されます。

### トークン管理

トークンには以下の情報が含まれます：

- **ユーザーID**：一意のユーザー識別子
- **ロール**：ユーザーの権限レベル（USER、ADMIN など）
- **発行時刻**：トークンが発行された時刻
- **有効期限**：トークンの有効期限（通常は1時間）
- **ユーザーエージェント**：リクエスト元のブラウザ/デバイス情報

トークンの更新は以下のように行われます：

1. トークンの有効期限が15分未満になると、自動的に更新されます。
2. 更新されたトークンは、元のトークンと同じユーザー情報を持ちますが、有効期限が延長されます。
3. ユーザーエージェントが変更された場合、セキュリティ上の理由からトークンの更新が拒否されることがあります。

### セッションハイジャック対策

セッションハイジャックを防止するために、以下の対策が実装されています：

1. **ユーザーエージェント検証**：
   - トークン生成時にユーザーエージェント情報が保存されます。
   - 各リクエストごとに、現在のユーザーエージェントとトークンに保存されたユーザーエージェントが比較されます。
   - 不一致がある場合、セッションが無効化されます。

2. **セキュアCookie設定**：
   - HTTPOnly属性により、JavaScriptからのCookieアクセスを防止します。
   - Secure属性により、HTTPS接続でのみCookieが送信されるようにします。
   - SameSite=Lax属性により、クロスサイトリクエストでのCookie送信を制限します。

3. **IP検証**（オプション）：
   - 設定により、IPアドレスの変更を検出し、セッションを無効化することができます。
   - モバイルネットワークなど、IPが頻繁に変更される環境では無効化できます。

4. **短い有効期限**：
   - トークンの有効期限を短く設定し、不正利用のリスクを軽減します。
   - 自動更新メカニズムにより、正規ユーザーの使用感には影響しません。

### CSRF対策

CSRF（クロスサイトリクエストフォージェリ）攻撃を防止するために、以下の対策が実装されています：

1. **CSRFトークン**：
   - フォーム送信時にCSRFトークンが必要です。
   - トークンはサーバーサイドで生成され、クライアントに送信されます。
   - フォーム送信時に、トークンが検証されます。

2. **SameSite Cookie**：
   - SameSite=Lax属性により、クロスサイトリクエストでのCookie送信を制限します。
   - これにより、多くのCSRF攻撃を防止できます。

3. **Refererチェック**：
   - リクエストのRefererヘッダーが検証され、許可されたドメインからのリクエストのみが受け入れられます。
   - Refererヘッダーが欠落している場合、追加の検証が行われます。

4. **Content-Type検証**：
   - JSONリクエストの場合、Content-Typeヘッダーが検証されます。
   - これにより、一部のCSRF攻撃を防止できます。

## 脆弱性対策

### XSS対策

XSS（クロスサイトスクリプティング）攻撃を防止するために、以下の対策が実装されています：

1. **出力エスケープ**：
   - ユーザー入力データは、表示前に適切にエスケープされます。
   - React/Next.jsのデフォルトのエスケープメカニズムが使用されます。

2. **Content-Security-Policy**：
   - スクリプトの実行を制限するCSPヘッダーが設定されています。
   - インラインスクリプトは禁止され、許可されたドメインからのスクリプトのみが実行できます。

3. **HTTPOnly Cookie**：
   - セッションCookieはHTTPOnly属性を持ち、JavaScriptからアクセスできません。
   - これにより、XSS攻撃によるセッション情報の漏洩を防止します。

4. **入力検証**：
   - すべてのユーザー入力は、サーバーサイドで検証されます。
   - 不正な入力は拒否され、エラーメッセージが表示されます。

### SQLインジェクション対策

SQLインジェクション攻撃を防止するために、以下の対策が実装されています：

1. **ORM（Prisma）の使用**：
   - 直接SQLクエリを書く代わりに、Prismaが使用されています。
   - Prismaは、パラメータ化されたクエリを使用し、SQLインジェクションを防止します。

2. **パラメータ化されたクエリ**：
   - 直接SQLを使用する場合でも、パラメータ化されたクエリが使用されます。
   - ユーザー入力は、クエリの一部として直接使用されることはありません。

3. **最小権限の原則**：
   - データベースユーザーには、必要最小限の権限のみが付与されています。
   - これにより、SQLインジェクションが成功した場合でも、被害を最小限に抑えることができます。

### レート制限

DoS攻撃やブルートフォース攻撃を防止するために、以下のレート制限が実装されています：

1. **認証エンドポイント**：
   - ログイン試行は、IPアドレスごとに制限されています（例：10回/分）。
   - 制限を超えると、一時的にブロックされます。

2. **API エンドポイント**：
   - 一般的なAPIリクエストは、ユーザーごとに制限されています（例：100回/分）。
   - 高頻度のリクエストが必要な特定のエンドポイントには、個別の制限が設定されています。

3. **ファイルアップロード**：
   - ファイルアップロードは、ユーザーごとに制限されています（例：10回/時間）。
   - ファイルサイズにも制限があります（例：最大10MB）。

### ファイルアップロードセキュリティ

ファイルアップロードに関連するセキュリティリスクを軽減するために、以下の対策が実装されています：

1. **ファイルタイプの検証**：
   - アップロードされたファイルのMIMEタイプとファイル拡張子が検証されます。
   - 許可されたファイルタイプのみがアップロードできます（例：.pptx, .docx, .pdf）。

2. **ファイルサイズの制限**：
   - アップロードされたファイルのサイズに上限があります（例：最大10MB）。
   - 大きすぎるファイルは拒否されます。

3. **ファイル名のサニタイズ**：
   - アップロードされたファイルの名前は、安全な形式に変換されます。
   - これにより、パストラバーサル攻撃などを防止します。

4. **ストレージの分離**：
   - アップロードされたファイルは、Webルートとは別の場所に保存されます。
   - ファイルへのアクセスは、認証と認可を通じて制御されます。

## 監査とログ

### セキュリティログ

セキュリティ関連のイベントは、以下のように記録されます：

1. **認証イベント**：
   - ログイン試行（成功/失敗）
   - パスワード変更
   - アカウントロック
   - 多要素認証

2. **アクセス制御**：
   - 権限のないリソースへのアクセス試行
   - 権限変更
   - ロール変更

3. **システム変更**：
   - 設定変更
   - ユーザー作成/削除
   - チーム作成/削除

### アクティビティログ

ユーザーのアクティビティは、以下のように記録されます：

1. **リソース操作**：
   - ファイルアップロード/ダウンロード
   - 翻訳実行
   - プロジェクト作成/編集/削除

2. **アカウント操作**：
   - プロフィール更新
   - サブスクリプション変更
   - 支払い処理

3. **チーム操作**：
   - メンバー招待
   - メンバー削除
   - 権限変更

### 異常検知

セキュリティ上の異常を検出するために、以下の仕組みが実装されています：

1. **ログイン異常**：
   - 通常とは異なる場所からのログイン
   - 短時間での複数回のログイン試行
   - 複数のデバイスからの同時ログイン

2. **使用パターン異常**：
   - 通常とは異なるリソースへのアクセス
   - 短時間での大量のリクエスト
   - 通常とは異なる時間帯のアクティビティ

3. **自動アラート**：
   - 重大なセキュリティイベントが発生した場合、管理者に自動通知されます。
   - 異常なアクティビティが検出された場合、ユーザーに通知されることがあります。

## トラブルシューティング

### 認証問題

認証に関する一般的な問題と解決策：

1. **ログインできない**：
   - パスワードが正しいことを確認してください。
   - アカウントがロックされていないか確認してください。
   - ブラウザのCookieが有効になっていることを確認してください。
   - 別のブラウザでログインを試してみてください。

2. **セッションが突然終了する**：
   - ブラウザのCookieが削除されていないか確認してください。
   - 複数のデバイスでログインしている場合、他のデバイスでログアウトしていないか確認してください。
   - ネットワーク接続が安定していることを確認してください。
   - ブラウザを更新してみてください。

3. **パスワードをリセットできない**：
   - メールアドレスが正しいことを確認してください。
   - スパムフォルダを確認してください。
   - メールサーバーが正常に動作していることを確認してください。
   - サポートに連絡してください。

### アクセス権限問題

アクセス権限に関する一般的な問題と解決策：

1. **リソースにアクセスできない**：
   - 適切な権限を持っていることを確認してください。
   - チームメンバーである場合、チーム管理者に権限を確認してください。
   - ログアウトして再度ログインしてみてください。
   - ブラウザのキャッシュをクリアしてみてください。

2. **権限が正しく反映されない**：
   - ページを更新してみてください。
   - ログアウトして再度ログインしてみてください。
   - 権限が最近変更された場合、反映に時間がかかることがあります。
   - 管理者に連絡して、権限設定を確認してください。

3. **チームリソースにアクセスできない**：
   - チームメンバーであることを確認してください。
   - チーム内での役割と権限を確認してください。
   - チーム管理者に連絡して、アクセス権を確認してください。
   - チームが削除されていないか確認してください。