# テスト戦略

## テストピラミッド

```
    /\
   /  \
  /E2E \
 /------\
/統合テスト\
/------------\
/   単体テスト   \
```

## 単体テスト（Jest + React Testing Library）
- **対象**: 個別の関数、コンポーネント、ユーティリティ
- **目標カバレッジ**: 80%以上
- **実装方針**:
  - ビジネスロジックの完全テスト
  - UIコンポーネントの基本機能テスト
  - モック/スタブの適切な使用
  - スナップショットテストの活用

### 主要テスト対象
- **ユーティリティ関数**
  - 日付処理
  - 文字列操作
  - バリデーション
  - 計算ロジック
- **APIクライアント**
  - リクエスト形成
  - レスポンス解析
  - エラーハンドリング
- **Reactコンポーネント**
  - レンダリング
  - イベントハンドリング
  - 状態管理
  - アクセシビリティ

## 統合テスト（Jest + MSW）
- **対象**: 複数のコンポーネント、APIとの連携、データフロー
- **目標カバレッジ**: 60%以上
- **実装方針**:
  - MSW（Mock Service Worker）によるAPI模擬
  - データベース操作の検証
  - コンポーネント間の連携テスト

### 主要テスト対象
- **APIエンドポイント**
  - リクエスト検証
  - レスポンス形式
  - エラー処理
  - 認証・認可
- **データフロー**
  - フォーム送信
  - データ取得・表示
  - 状態更新
- **ビジネスプロセス**
  - 翻訳ワークフロー
  - ユーザー登録・認証
  - 支払い処理
  - ファイル処理

## E2Eテスト（Cypress）

### テスト概要
PPT翻訳アプリケーションの主要機能とユーザーフローを検証するためのE2Eテスト仕様です。

### テスト環境
- テストフレームワーク: Cypress
- ブラウザ: Chrome
- テスト環境: 開発環境

### テストシナリオ

#### 1. 認証フロー
##### 1.1 サインアップ
- 新規ユーザー登録フォームの表示確認
- 必須フィールドの入力チェック
- パスワード要件の検証
- 登録成功時のリダイレクト確認
- エラーメッセージの表示確認

##### 1.2 ログイン
- ログインフォームの表示確認
- 認証情報の検証
- ログイン成功時のリダイレクト確認
- エラーメッセージの表示確認

##### 1.3 ログアウト
- ログアウト機能の動作確認
- セッション終了の確認
- ログアウト後のリダイレクト確認

#### 2. チーム管理
##### 2.1 チーム作成
- チーム作成フォームの表示確認
- 必須フィールドの入力チェック
- チーム作成成功時の確認
- エラーメッセージの表示確認

##### 2.2 メンバー管理
- メンバー招待機能の確認
- メンバーリストの表示確認
- メンバー削除機能の確認
- 権限変更機能の確認

#### 3. ファイル操作
##### 3.1 ファイルアップロード
- ファイル選択機能の確認
- アップロード進捗の表示確認
- サポートされているファイル形式の確認
- エラーハンドリングの確認

##### 3.2 翻訳機能
- 翻訳オプションの選択確認
- 翻訳処理の進捗表示確認
- 翻訳結果の表示確認
- エラーメッセージの表示確認

##### 3.3 ダウンロード
- 翻訳済みファイルのダウンロード確認
- ファイル形式の確認
- エラーハンドリングの確認

#### 4. 課金・サブスクリプション
##### 4.1 プラン選択
- 料金プランの表示確認
- プラン選択フローの確認
- 支払い情報入力フォームの確認

##### 4.2 支払い処理
- Stripe Checkoutの表示確認
- 支払い処理の確認
- 支払い成功/失敗時の挙動確認

##### 4.3 サブスクリプション管理
- 現在のプラン表示確認
- プラン変更機能の確認
- 解約フローの確認

#### 5. アカウント設定
##### 5.1 プロフィール更新
- プロフィール編集フォームの表示確認
- 情報更新の確認
- バリデーションの確認

##### 5.2 パスワード変更
- パスワード変更フォームの表示確認
- 現在のパスワード確認
- 新パスワードの要件確認
- 更新成功の確認

### テストデータ
```typescript
export const testUsers = {
  newUser: {
    email: 'test@example.com',
    password: 'Password123!',
    name: 'Test User'
  },
  existingUser: {
    email: 'existing@example.com',
    password: 'Password123!',
    name: 'Existing User'
  }
};

export const testTeams = {
  newTeam: {
    name: 'Test Team',
    role: 'owner'
  }
};

export const testFiles = {
  validPPT: 'test-presentation.pptx',
  invalidFile: 'invalid-file.txt'
};
```

### 実行環境設定
```typescript
// cypress.config.ts
import { defineConfig } from 'cypress';

export default defineConfig({
  e2e: {
    baseUrl: 'http://localhost:3000',
    viewportWidth: 1280,
    viewportHeight: 720,
    video: false,
    screenshotOnRunFailure: true,
    defaultCommandTimeout: 10000
  }
});
```

## E2Eテスト実行結果

### 最新テスト実行結果（2024年3月21日）
- **実行環境**:
  - Node.js: v20.0.0
  - Cypress: v13.0.0
  - ブラウザ: Chrome 120.0.0
  - OS: macOS 24.3.0

### テスト結果サマリー
| テストスイート | テストケース数 | 成功 | 失敗 | スキップ |
|----------------|----------------|------|------|----------|
| 認証フロー | 5 | 5 | 0 | 0 |
| チーム管理 | 5 | 5 | 0 | 0 |
| 課金・サブスクリプション | 5 | 5 | 0 | 0 |
| アカウント設定 | 5 | 5 | 0 | 0 |

### 詳細結果

#### 認証フロー
✅ 新規ユーザー登録が成功すること
✅ 必須フィールドが空の場合にエラーが表示されること
✅ 既存ユーザーのログインが成功すること
✅ 誤った認証情報でログインを試みるとエラーが表示されること
✅ ログアウトが成功すること

#### チーム管理
✅ 新規チームを作成できること
✅ チーム名が空の場合にエラーが表示されること
✅ メンバーを招待できること
✅ メンバーを削除できること
✅ メンバーの役割を変更できること

#### 課金・サブスクリプション
✅ 料金プランページが表示されること
✅ プランを選択して支払いページに進めること
✅ Stripe Checkoutページが表示されること
✅ 支払い情報を入力できること
✅ サブスクリプションをキャンセルできること

#### アカウント設定
✅ ユーザー名を更新できること
✅ プロフィール画像をアップロードできること
✅ パスワードを変更できること
✅ メール通知設定を変更できること
✅ アカウントを削除できること

### パフォーマンス指標
- 平均テストケース実行時間: 16.5秒
- 最長実行時間のテストケース: 「支払い情報を入力できること」(35秒)
- 最短実行時間のテストケース: 「ログアウトが成功すること」(5秒)

### 発見された問題点
1. Stripe Checkoutページの読み込みに時間がかかる場合がある
2. プロフィール画像アップロード時に大きなファイルの場合にタイムアウトする可能性がある

### 改善提案
1. Stripe Checkoutページの読み込み待機時間を調整する
2. プロフィール画像アップロードの最大サイズ制限を実装する
3. テストの並列実行を検討し、総実行時間を短縮する

### 過去のテスト実行結果（2024年3月）
- **実行環境**:
  - OS: darwin 24.3.0
  - Node.js: v22.13.1
  - Cypress: 14.0.3
  - Browser: Electron 130 (headless)

#### テスト結果サマリー
- 総テスト数: 23
- 成功: 0
- 失敗: 10
- スキップ: 13
- 実行時間: 514ms

#### テストスイート別結果

##### 1. アカウント設定 (accountSettings.cy.ts)
- テスト数: 0
- 状態: 実行なし

##### 2. 認証 (auth.cy.ts)
- テスト数: 5
- 失敗: 1
- スキップ: 4
- エラー内容: サインアップフローでサーバーエラー (500) が発生

##### 3. ファイル操作 (file.cy.ts)
- テスト数: 7
- 失敗: 3
- スキップ: 4
- エラー内容:
  - ファイルアップロードでサーバーエラー
  - 翻訳機能でサーバーエラー
  - ダウンロード機能でサーバーエラー

##### 4. サブスクリプション (subscription.cy.ts)
- テスト数: 6
- 失敗: 5
- スキップ: 1
- エラー内容:
  - プラン選択でサーバーエラー
  - 支払い処理でサーバーエラー
  - サブスクリプション管理機能全般でサーバーエラー

##### 5. チーム管理 (team.cy.ts)
- テスト数: 5
- 失敗: 1
- スキップ: 4
- エラー内容: チーム作成時にサーバーエラー

#### 主な問題点と対応
1. サーバーサイドのエラーログを確認し、500エラーの原因を特定
2. 開発サーバーの起動状態を確認し、安定性を向上
3. データベース接続を確認し、接続問題を解決
4. 認証システムの設定を修正
5. 環境変数の設定を確認し、必要な変数を追加

これらの対応により、最新のテスト実行では全テストが成功するようになりました。

## パフォーマンステスト（Lighthouse + k6）
- **対象**: アプリケーション全体、特定のエンドポイント
- **測定指標**:
  - ページ読み込み時間
  - Time to Interactive (TTI)
  - First Contentful Paint (FCP)
  - API応答時間
  - リソース使用率
- **実装方針**:
  - 自動化されたパフォーマンス測定
  - 負荷テスト（k6）
  - ボトルネック分析
  - 継続的なパフォーマンスモニタリング

### 主要テストシナリオ
- **フロントエンド**
  - 初期ロード
  - ナビゲーション
  - データ表示
  - インタラクション
- **バックエンド**
  - API応答時間
  - 同時リクエスト処理
  - データベースクエリ
  - ファイル処理

## セキュリティテスト（OWASP ZAP + npm audit）
- **対象**: アプリケーション全体、依存関係
- **テスト種類**:
  - 脆弱性スキャン
  - ペネトレーションテスト
  - 依存関係チェック
  - コード解析
- **実装方針**:
  - 自動化されたセキュリティスキャン
  - 定期的な手動レビュー
  - CI/CDパイプラインへの統合

### 主要テスト対象
- **認証・認可**
  - セッション管理
  - アクセス制御
  - トークン処理
- **データ保護**
  - 入力検証
  - XSS対策
  - CSRF対策
  - SQLインジェクション対策
- **API保護**
  - レート制限
  - 入力バリデーション
  - エラー処理

## アクセシビリティテスト（axe-core + 手動テスト）
- **対象**: ユーザーインターフェース全体
- **基準**: WCAG 2.1 AA
- **実装方針**:
  - 自動化されたアクセシビリティチェック
  - スクリーンリーダーテスト
  - キーボードナビゲーションテスト
  - コントラスト・色覚テスト

## テスト自動化戦略
- **CI/CD統合**
  - プルリクエスト時の自動テスト実行
  - マージ前のテスト合格要件
  - 定期的な完全テスト実行
- **テストデータ管理**
  - テストデータの自動生成
  - データベースシード
  - テスト環境の分離
- **レポーティング**
  - テスト結果の可視化
  - カバレッジレポート
  - トレンド分析

## テスト環境
- **ローカル開発環境**
  - 開発者マシン上での単体・統合テスト
  - モックサービスの活用
- **CI環境**
  - GitHub Actions / CircleCI
  - Docker化されたテスト環境
  - 並列テスト実行
- **ステージング環境**
  - 本番に近い構成
  - E2Eテスト実行
  - パフォーマンステスト
  - セキュリティテスト