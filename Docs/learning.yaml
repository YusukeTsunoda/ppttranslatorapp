title: "スライド画像表示と翻訳APIの不具合分析と学び"
date: "2025-05-07"
author: "開発チーム"

# 今回発生した不具合の概要
issues:
  - id: "issue-001"
    title: "スライド画像が表示されない問題"
    description: "アップロードしたスライドの画像が正しく表示されず、画像読み込みエラーが発生していた"
    root_cause: "ファイルパスの構築に問題があり、'users'が二重に含まれるパス構造になっていた"
    
  - id: "issue-002"
    title: "翻訳APIのエラー"
    description: "翻訳ボタンを押すとAPIエラーが発生していた"
    root_cause: "翻訳リクエストにおいてfileIdの取得方法が不適切で、正しいfileIdが送信されていなかった"
    
  - id: "issue-003"
    title: "スライド内テキストのレイアウト問題"
    description: "スライド内テキストが右側に表示されており、ユーザビリティに問題があった"
    root_cause: "UIレイアウトの設計が最適化されておらず、ユーザーの期待と異なるレイアウトになっていた"

# 原因の分析
root_causes_analysis:
  - category: "パス構造の一貫性の欠如"
    description: "ファイルパス構造の定義が複数の場所に散在しており、一貫性が保たれていなかった"
    examples:
      - "スライドAPIでは `/tmp/users/users/{userId}/{fileId}/slides/{imageName}` というパス構造を使用"
      - "実際のファイル構造は `/tmp/users/{userId}/{fileId}/slides/{imageName}` であった"
      - "FILE_CONFIGの設定とパス構築の間に不整合があった"
  
  - category: "APIインターフェースの不明確さ"
    description: "翻訳APIのインターフェース定義が不明確で、必要なパラメータの取得方法が適切に実装されていなかった"
    examples:
      - "fileIdの取得方法が文字列分割（split）に依存しており、URLの構造変更に弱かった"
      - "APIのパラメータ要件がコード内に散在し、一元管理されていなかった"
  
  - category: "テスト不足"
    description: "エッジケースや異常系のテストが不足しており、実際の環境での問題が見逃されていた"
    examples:
      - "異なるパス構造でのファイル読み込みテストが不足"
      - "APIリクエストの失敗ケースのテストが不足"

# 問題解決に時間がかかった理由
time_consuming_factors:
  - factor: "ログ情報の不足"
    description: "初期実装では詳細なデバッグ情報が出力されておらず、問題の特定に時間がかかった"
    
  - factor: "パス構造の複雑さ"
    description: "複数のパス構造が混在しており、実際のファイルシステムとの整合性確認に時間がかかった"
    
  - factor: "コードの分散"
    description: "ファイルパス関連のロジックが複数のファイルに分散しており、全体像の把握が困難だった"

# 実装時に気づけなかった理由
implementation_blindspots:
  - blindspot: "設計ドキュメントとの乖離"
    description: "実装が進むにつれて設計ドキュメントとの乖離が生じ、参照されなくなっていた"
    
  - blindspot: "段階的な変更による副作用"
    description: "パス構造の変更が段階的に行われ、古い構造と新しい構造が混在する状態になっていた"
    
  - blindspot: "クロスチェックの不足"
    description: "コードレビューやペアプログラミングなどのクロスチェック機会が不足していた"

# 今後の改善策
improvements:
  - area: "設計と実装の一貫性確保"
    actions:
      - "ファイルパス構造を一元管理するクラスやモジュールを強化し、すべての箇所で同じ方法でパスを構築する"
      - "設計ドキュメントを常に最新の状態に保ち、実装との乖離を防ぐ"
      - "変更履歴を明確に記録し、移行期間中の互換性を確保する"
  
  - area: "テスト強化"
    actions:
      - "ファイルパス構築のユニットテストを追加"
      - "APIインターフェースの入出力テストを強化"
      - "エッジケースや異常系のテストケースを追加"
  
  - area: "ログとデバッグ情報"
    actions:
      - "重要なポイントでの詳細なログ出力を標準化"
      - "エラー発生時の詳細情報収集を自動化"
      - "ユーザー体験に影響を与えない範囲でのデバッグ情報の充実"
  
  - area: "コードレビューとペアプログラミング"
    actions:
      - "複雑なロジックや重要な変更に対するペアプログラミングの実施"
      - "コードレビューチェックリストの作成と活用"
      - "定期的なコードウォークスルーの実施"

# 学びと教訓
lessons_learned:
  - lesson: "パス構造の一元管理の重要性"
    description: "ファイルパスなどの重要な構造は一元管理し、すべての箇所で同じ方法で構築することが重要"
    
  - lesson: "段階的な変更の管理"
    description: "段階的な変更を行う場合は、移行計画を明確にし、古い構造と新しい構造の共存期間を最小限にする"
    
  - lesson: "早期かつ詳細なログ出力"
    description: "問題解決の効率化のために、早い段階から詳細なログ出力を実装することが重要"
    
  - lesson: "APIインターフェースの明確な定義"
    description: "APIのインターフェース定義を明確にし、ドキュメント化することで実装ミスを防ぐ"
    
  - lesson: "テスト駆動開発の活用"
    description: "複雑なロジックや重要な機能は、テスト駆動開発で実装することで品質を確保する"

# 今後のベストプラクティス
best_practices:
  - practice: "パスヘルパー関数の活用"
    description: "ファイルパスの構築には専用のヘルパー関数を使用し、直接的な文字列操作を避ける"
    example: |
      // 悪い例
      const path = `/tmp/users/${userId}/${fileId}/slides/${imageName}`;
      
      // 良い例
      const path = filePathManager.getSlidePath(userId, fileId, imageName);
    
  - practice: "APIパラメータの抽出関数"
    description: "URLやパスからのパラメータ抽出には専用の関数を使用し、正規表現などで堅牢に実装する"
    example: |
      // 悪い例
      const fileId = url.split('/')[3];
      
      // 良い例
      const fileId = extractFileIdFromUrl(url);
    
  - practice: "段階的な変更の管理"
    description: "パス構造などの重要な変更は、移行計画を立て、古い構造と新しい構造の共存期間を明確にする"
    example: |
      // 移行計画の例
      // 1. 新しいパス構造を追加（両方をサポート）
      // 2. 新しいパス構造への移行を促進（古い構造は非推奨）
      // 3. 古いパス構造のサポートを削除
    
  - practice: "詳細なログ出力"
    description: "重要なポイントでは詳細なログを出力し、問題解決を効率化する"
    example: |
      console.log('スライドAPI - パスパラメータ:', {
        path: params.path,
        fileId,
        imageName,
        fullPath: params.path.join('/'),
        pathLength: params.path.length,
        timestamp: new Date().toISOString()
      });

# learning.yaml

- title: npm run build で発生した主なエラーと対応・再発防止策
  items:
    - error: "Type error: Parameter 'index' implicitly has an 'any' type."
      cause: "TypeScriptの暗黙any型禁止設定により、map等のコールバック引数の型が明示されていない場合に発生。"
      solution: "index: number など、明示的に型注釈を付与する。"
      prevention: "TypeScriptのstrict設定を維持し、コールバック引数には必ず型注釈を付与する習慣を徹底する。"

    - error: "Type error: Object literal may only specify known properties, and 'IconLeft' does not exist in type 'Partial<CustomComponents>'."
      cause: "外部ライブラリ（react-day-picker）のカスタムコンポーネント仕様を正しく理解せず、存在しないプロパティ（IconLeft/IconRight）を指定した。"
      solution: "公式ドキュメントを確認し、PreviousMonthButton/NextMonthButtonやChevronなど、正しいカスタマイズ方法を使う。"
      prevention: "外部ライブラリのAPIや型定義は必ず公式ドキュメント・型定義ファイルで確認し、独自解釈でpropsを追加しない。"

    - error: "Type error: Property 'direction' does not exist on type ..."
      cause: "react-day-pickerのChevronカスタムコンポーネントにdirectionというpropsが渡されると誤解した。"
      solution: "directionではなく、PreviousMonthButton/NextMonthButtonで左右ボタンを個別にカスタマイズする。"
      prevention: "カスタムコンポーネントのpropsは型定義を必ず確認し、存在しないpropsを受け取らない。"

    - error: "Type error: 'searchParams' is possibly 'null'."
      cause: "useSearchParams()の戻り値がnullの可能性を考慮せず、nullチェックを怠った。"
      solution: "searchParamsがnullの場合の分岐を追加し、デフォルト値を返すように修正。"
      prevention: "nullを返す可能性のあるAPI利用時は必ずnullチェックを行う。"

    - error: "Type error: Argument of type 'string | null' is not assignable to parameter of type 'string'."
      cause: "router.push等の引数にstring | null型が渡る可能性を考慮していなかった。"
      solution: "router.push(newUrl || '') のように、必ずstring型を渡すよう修正。"
      prevention: "string型が必須のAPIには、型アサーションやデフォルト値で型を保証してから渡す。"

- title: Next.js SSR/静的エクスポート不具合の原因と学び
  date: "2025-05-08"
  items:
    - error: "Export encountered errors on following paths: ... などの静的エクスポートエラー"
      cause: |
        - Next.js App Router構成でSSR/サーバー専用処理（DBアクセス・認証）を含むページが静的エクスポート不可であることを見落としていた。
        - サーバーコンポーネントからクライアントラッパーをimportするなど、App Routerの設計原則に反したimport構造が混在していた。
        - Babel/SWCやoutput設定、Vercelのビルドコマンドなど複数の要因が絡み合い、根本原因の特定が難航した。
      solution: |
        - SSR運用（output: 'standalone'）に統一し、静的エクスポートは行わない。
        - サーバーコンポーネントからクライアントラッパーをimportしない設計を徹底。
        - Babel設定を見直し、Next.js標準のSWCビルドに戻す。
        - ビルドコマンドや環境変数、Vercel設定を再点検。
      prevention: |
        - SSR/SSG/ISRの違いとNext.js App Routerの制約をチームで共有し、設計段階で静的エクスポート不可なページを明確化する。
        - サーバー/クライアントコンポーネントのimportルールをドキュメント化し、レビュー時に必ずチェックする。
        - Babelやoutput設定、CI/CDのビルドコマンドを一元管理し、変更時は影響範囲を明確にする。
        - ビルドエラー発生時は、公式ドキュメントやエラーメッセージをもとに、SSR/SSG/静的エクスポートの観点から早期に切り分ける。
    - time_consuming_factors:
        - "App RouterのSSR/SSG/静的エクスポートの仕様理解不足により、原因の切り分けに時間を要した。"
        - "サーバー/クライアントコンポーネントのimport構造が複雑化し、どこで何がimportされているか追跡に手間取った。"
        - "Babelやoutput設定、Vercelのビルドコマンドなど複数の設定が絡み合い、どこが本質的な原因か特定しづらかった。"
        - "エラー発生時のビルドログや設定ファイルの確認が後手に回り、調査が長期化した。"
    - improvements:
        - "SSR/SSG/静的エクスポートの設計方針をプロジェクト初期に明確化し、ドキュメント化する。"
        - "サーバー/クライアントコンポーネントのimportルールをlintやレビューで自動チェックする仕組みを導入する。"
        - "Babelやoutput、CI/CDのビルド設定をREADMEやdocsに明記し、変更時は必ずPRレビューを通す。"
        - "ビルドエラー発生時は、まず公式ドキュメント・エラーメッセージ・設定ファイルを系統的に確認する運用を徹底する。"
    - lessons_learned:
        - "Next.js App RouterのSSR/SSG/静的エクスポートの仕様と制約を深く理解し、設計・実装に反映することの重要性。"
        - "サーバー/クライアントコンポーネントのimport構造は厳格に分離し、設計原則を守ること。"
        - "ビルドやデプロイの設定は一元管理し、複数の設定が絡む場合は影響範囲を明確にすること。"
        - "エラー発生時は、設定・ログ・公式ドキュメントをもとに系統的に切り分けること。"
    - best_practices:
        - "SSR/SSG/静的エクスポートの設計方針をREADMEやdocsに明記し、チーム全体で共有する。"
        - "サーバー/クライアントコンポーネントのimportルールをeslint-pluginやカスタムlintで自動化する。"
        - "Babelやoutput、CI/CDのビルド設定は一元管理し、変更時は必ずPRレビュー・動作確認を行う。"
        - "ビルドエラー発生時は、まず公式ドキュメント・エラーメッセージ・設定ファイルを確認し、安易に設定を変更しない。"

- title: Babel利用禁止の方針
  date: "2025-05-08"
  items:
    - rule: "今後はBabelを使わず、Next.js標準のSWCのみを利用する。"
      reason: "Babel設定がSWCを無効化し、Next.jsのサーバー/クライアントコンポーネントの挙動やビルドに予期せぬ不具合を引き起こすため。"
      enforcement: |
        - Babel関連の設定ファイル（babel.config.js等）はリポジトリから削除する。
        - jestやeslint等の設定からもBabel依存を排除する。
        - 今後Babelを導入・追加する場合は、必ず技術的なレビューと影響範囲の検証を行う。
