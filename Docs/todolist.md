# Python実装とDockerによるVercelデプロイ計画

## 目標
現在のNext.jsアプリケーションをPythonで実装し、Dockerコンテナ化してVercelにデプロイする

## 実装手順

### 1. Pythonバックエンドの構築
- [x] FastAPIフレームワークを使用したバックエンドの構築
- [x] 必要なPythonパッケージの整理とrequirements.txtの作成
- [x] PPTXパーサー機能のPython実装への移行
- [x] PPTXジェネレーター機能のPython実装への移行
- [ ] 認証機能のPython実装への移行
- [x] ファイルアップロード/ダウンロード機能の実装
- [x] エラーハンドリングの実装

### 2. Dockerコンテナ化
- [x] Dockerfileの作成
- [x] docker-compose.ymlの更新
- [ ] 開発環境用のコンテナ設定
- [x] 本番環境用のコンテナ設定
- [ ] 環境変数の管理方法の整備

### 3. フロントエンドとの連携
- [x] APIエンドポイントの整備
- [x] CORS設定の実装
- [ ] フロントエンドからのAPI呼び出し方法の調整
- [ ] 認証トークンの受け渡し方法の実装

### 4. Vercelデプロイ準備
- [x] Vercel.jsonの更新
- [x] Serverless Functionsの設定
- [ ] 環境変数の設定
- [ ] ビルドスクリプトの調整

### 5. デプロイとテスト
- [ ] ローカル環境でのテスト
- [ ] Vercelへのデプロイ
- [ ] デプロイ後の動作確認
- [ ] パフォーマンステスト

## 技術スタック
- バックエンド: Python 3.9+, FastAPI
- コンテナ化: Docker, docker-compose
- デプロイ: Vercel
- 依存パッケージ: python-pptx, Pillow, pdf2image

## デプロイ手順

1. リポジトリをクローン
```bash
git clone <repository-url>
cd ppttranslatorapp
```

2. Dockerイメージをビルド
```bash
cd python_backend
docker build -t ppt-translator-api .
```

3. ローカルでテスト実行
```bash
docker run -p 3000:3000 ppt-translator-api
```

4. Vercelにデプロイ
```bash
vercel
```

5. 環境変数の設定
Vercelダッシュボードで以下の環境変数を設定:
- `PORT`: 3000
- `ALLOWED_ORIGINS`: フロントエンドのURL（カンマ区切りで複数指定可能）

---

# タスクリスト（2024年3月16日更新）

## 優先度: 高
- [ ] マウスクリックが動作しない問題の修正
  - [ ] イベント伝播の問題を調査
  - [ ] クリックハンドラーの最適化
  - [ ] モバイルデバイスでのタッチイベント対応
- [ ] 翻訳履歴機能の実装
  - [ ] 履歴一覧表示の改善
  - [ ] 詳細表示機能の追加
  - [ ] フィルタリング機能の実装
  - [ ] ソート機能の実装
- [ ] パフォーマンス最適化
  - [ ] 大きなファイルの処理速度改善
  - [ ] 画像の最適化
  - [ ] コンポーネントの遅延ロード
  - [ ] APIレスポンスのキャッシュ
- [ ] 翻訳テキストの位置ずれ修正
  - [ ] 位置計算アルゴリズムの見直し
  - [ ] フォントサイズの自動調整機能
  - [ ] 言語ごとのレイアウト調整
- [ ] メモリリーク対応
  - [ ] 大きなファイル処理時のメモリ使用量監視
  - [ ] 不要なリソースの解放処理追加
  - [ ] WebWorkerの活用検討
- [ ] ドキュメント作成
  - [ ] 開発者向けドキュメント
  - [ ] APIドキュメント
  - [ ] セキュリティドキュメント
  - [ ] ユーザーガイド

## 優先度: 中
- [ ] ダークモードの実装
  - [ ] カラーテーマの設計
  - [ ] ユーザー設定の保存
  - [ ] システム設定との連携
- [ ] バッチ翻訳機能の実装
  - [ ] 複数ファイルの一括アップロード
  - [ ] バックグラウンド処理の実装
  - [ ] 進捗状況の表示
- [ ] API連携機能の実装
  - [ ] 外部サービスとの連携インターフェース
  - [ ] APIキー管理
  - [ ] 使用量の監視
- [ ] 請求書生成機能の実装
  - [ ] 請求書テンプレートの作成
  - [ ] PDF生成機能
  - [ ] メール送信機能
- [ ] 統計・分析機能の実装
  - [ ] 使用状況ダッシュボード
  - [ ] グラフ表示
  - [ ] エクスポート機能
- [ ] RLS（Row Level Security）の実装
  - [ ] テーブルごとのポリシー設定
  - [ ] ロールベースのアクセス制御
  - [ ] 監査ログの自動記録

## 優先度: 低
- [ ] ブログ機能の実装
  - [ ] 記事投稿システム
  - [ ] カテゴリ管理
  - [ ] コメント機能
- [ ] 多言語対応の拡充
  - [ ] 新しい言語ペアの追加
  - [ ] 言語固有の処理の最適化
  - [ ] 翻訳品質の向上
- [ ] カスタムテーマ機能
  - [ ] テーマエディタ
  - [ ] プリセットテーマ
  - [ ] テーマの共有機能
- [ ] APIドキュメントの整備
  - [ ] Swagger/OpenAPIの導入
  - [ ] エンドポイントの詳細説明
  - [ ] サンプルコード

## E2Eテスト改善計画（2024年3月16日更新）

### 実装済み
- [x] 認証テストの実装
  - [x] テスト用のユーザーアカウント設定
  - [x] 認証情報の環境変数化
  - [x] サインイン後のリダイレクト問題の解決
  - [x] エラーメッセージ検証の改善
  - [x] 実際のUIテキストとテスト期待値の同期
  - [x] サインインエラー要素のdata-testid属性の追加
  - [x] 認証フローのリダイレクト問題の調査と修正
- [x] テストデータの準備
  - [x] サンプルPPTXファイルの作成
  - [x] テスト用データベースシードスクリプトの実装
  - [x] テスト環境のリセット機能
  - [x] 有効なPPTXテストファイルの作成（実際のスライドとテキストを含む）
  - [x] テストデータの自動生成スクリプトの実装
- [x] テスト環境の安定化
  - [x] タイムアウト値の最適化
  - [x] 非同期処理の待機時間調整
  - [x] テスト実行の並列化設定
  - [x] ポート番号の一貫性確保（3000, 3001, 3002の混在問題）
  - [x] テスト実行前のアプリケーション状態リセット機能
  - [x] ネットワークリクエストの待機戦略の改善
- [x] UI要素の識別子追加
  - [x] 残りのコンポーネントにdata-testid属性を追加
  - [x] テスト用のセレクタ定義の統一
  - [x] アクセシビリティ属性の活用
  - [x] サインインフォームの各要素にdata-testid追加
  - [x] 翻訳ページの各UI要素にdata-testid追加
  - [x] エラーメッセージ表示要素にdata-testid追加
- [x] 段階的テスト実装
  - [x] 認証フローテストの完成
  - [x] ファイルアップロードテストの実装
  - [x] 翻訳処理テストの実装
  - [x] ダウンロードテストの実装
  - [x] 各テストケースの独立性確保（テスト間の依存関係排除）
  - [x] 失敗時のリトライ戦略の改善

### 次に実装すべき項目
1. **CI/CD統合**
   - [ ] GitHub Actionsでのテスト自動化
   - [ ] テスト結果レポートの生成
   - [ ] テストカバレッジの計測
   - [ ] テスト失敗時のスクリーンショット保存と分析
   - [ ] テスト実行時間の最適化

2. **テスト実行環境の整備**
   - [ ] Docker環境でのE2Eテスト実行設定
   - [ ] テスト用の独立したデータベース環境の構築
   - [ ] 本番環境に影響を与えないテスト実行の仕組み
   - [ ] テスト実行のログ収集と分析機能

3. **テストコードの品質向上**
   - [ ] テストコードのリファクタリング
   - [ ] 共通処理のユーティリティ関数化
   - [ ] テストケースのドキュメント化
   - [ ] テストコードのレビュープロセス確立

4. **テストケースの拡充**
   - [ ] プロフィール編集機能のテスト
   - [ ] 設定変更機能のテスト
   - [ ] エラー状態のテスト
   - [ ] 境界値テスト
   - [ ] パフォーマンステスト

5. **モバイル対応テスト**
   - [ ] レスポンシブデザインのテスト
   - [ ] タッチ操作のテスト
   - [ ] モバイル特有の問題の検出

## Supabase連携計画
### Phase 1: 基本設定とデータベース移行
- [ ] Supabase プロジェクトのセットアップ
  - [ ] プロジェクト作成
  - [ ] 環境変数の設定
  - [ ] Vercelとの連携設定
- [ ] データベーススキーマの移行
  - [ ] テーブル構造の移行
  - [ ] インデックスの設定
  - [ ] 外部キー制約の設定
- [ ] 認証システムの連携
  - [ ] NextAuthとSupabaseAuthの統合
  - [ ] ユーザーデータの移行
  - [ ] 認証フローのテスト

### Phase 2: ストレージとRLS実装
- [ ] ファイルストレージの設定
  - [ ] バケット構造の設計
  - [ ] アクセス制御の設定
  - [ ] ファイル移行スクリプトの作成
- [ ] RLSポリシーの実装
  - [ ] テーブルごとのポリシー設定
  - [ ] ロールベースのアクセス制御
  - [ ] ポリシーのテスト

### Phase 3: リアルタイム機能と最適化
- [ ] リアルタイム更新の実装
  - [ ] サブスクリプション設定
  - [ ] フロントエンドの連携
  - [ ] パフォーマンステスト
- [ ] エッジ関数の活用
  - [ ] 認証関連処理の移行
  - [ ] ファイル処理の最適化
  - [ ] CDN設定の最適化

# PPTXファイル処理エラーの原因と解決策

## 現在のエラー

```
Error: Loading presentation from: /Users/yusuketsunoda/Documents/cursor/ppttranslatorapp/tmp/users/cm7j3hlru0000q9p52ircao6q/uploads/1740485731542_q09harqiie_original.pptx
Error: Package not found at '/Users/yusuketsunoda/Documents/cursor/ppttranslatorapp/tmp/users/cm7j3hlru0000q9p52ircao6q/uploads/1740485731542_q09harqiie_original.pptx'
```

このエラーは、Python の `python-pptx` ライブラリが指定されたパスにあるPPTXファイルを開けないことを示しています。「Package not found」というエラーは、ファイルが見つからないか、ファイル形式が正しくないことを意味します。

## エラーの根本原因

このエラーが発生している根本的な原因は、**クライアントとサーバー間のリクエストデータの不一致**です。具体的には以下の問題があります：

1. **クライアント側の変更**: `app/(dashboard)/translate/page.tsx` の `handleDownload` 関数で、リクエストデータの形式が変更されました。
   ```javascript
   // 変更後のリクエストデータ
   const requestData = {
     fileId, // ファイルIDのみを送信
     slides: slides.map(slide => ({
       index: slide.index,
       texts: slide.texts.map((text: any, index: number) => ({
         text: text.text,
         translation: (
           editedTranslations[`${slide.index}-${index}`] || 
           slide.translations?.[index]?.text || 
           text.text
         ).trim()
       }))
     }))
   };
   ```

2. **サーバー側の期待**: `app/api/download/route.ts` では、異なる形式のリクエストデータを期待しています。
   ```javascript
   const { originalFilePath, slides } = body;
   
   // リクエストデータの検証
   if (!originalFilePath || !slides || !Array.isArray(slides)) {
     console.error("無効なリクエストデータ:", {
       hasOriginalFilePath: !!originalFilePath,
       hasSlides: !!slides,
       slidesIsArray: Array.isArray(slides),
       userId: session.user.id,
       timestamp: new Date().toISOString()
     });
     return NextResponse.json({
       error: 'Invalid request data',
       details: 'リクエストデータが不正です',
       timestamp: new Date().toISOString()
     }, { status: 400 });
   }
   ```

3. **不一致の結果**: クライアントは `fileId` を送信していますが、サーバーは `originalFilePath` を期待しているため、サーバー側の検証で「リクエストデータが不正です」というエラーが発生しています。

## 処理フロー図

```
【現在の問題のあるフロー】
1. クライアント側: fileIdとslidesを含むリクエストデータを送信
   ↓
2. サーバー側: originalFilePathとslidesを期待
   ↓
3. サーバー側: originalFilePathが存在しないため検証エラー
   ↓
4. サーバー側: 「リクエストデータが不正です」エラーを返す
```

```
【修正後のあるべきフロー】
1. クライアント側: fileIdとslidesを含むリクエストデータを送信
   ↓
2. サーバー側: fileIdからoriginalFilePathを構築
   ↓
3. サーバー側: 実際のファイルパスを検索
   ↓
4. サーバー側: Pythonスクリプトを実行して翻訳済みPPTXを生成
   ↓
5. クライアント側: 生成されたファイルをダウンロード
```

## 必要な修正

### 1. サーバー側の修正 (`app/api/download/route.ts`)

```javascript
// リクエストボディを取得
const body = await req.json();
const { fileId, slides } = body; // originalFilePathの代わりにfileIdを受け取る

// リクエストデータの検証
if (!fileId || !slides || !Array.isArray(slides)) {
  console.error("無効なリクエストデータ:", {
    hasFileId: !!fileId,
    hasSlides: !!slides,
    slidesIsArray: Array.isArray(slides),
    userId: session.user.id,
    timestamp: new Date().toISOString()
  });
  return NextResponse.json({
    error: 'Invalid request data',
    details: 'リクエストデータが不正です',
    timestamp: new Date().toISOString()
  }, { status: 400 });
}

// fileIdから元のファイルパスを構築
const originalFilePath = filePathManager.getTempPath(session.user.id, fileId, 'original');
```

### 2. クライアント側とサーバー側の整合性確保

クライアント側とサーバー側で一貫したデータ形式を使用するために、以下の点に注意する必要があります：

1. リクエストとレスポンスの形式を明確に文書化する
2. 変更を行う場合は、クライアント側とサーバー側を同時に更新する
3. APIエンドポイントのテストを実施して、互換性を確認する

### 3. エラーハンドリングの強化

サーバー側でより詳細なエラーメッセージを提供し、クライアント側でそれを適切に表示することで、問題の診断と解決を容易にします：

```javascript
// サーバー側
return NextResponse.json({
  error: 'Invalid request data',
  details: `リクエストデータが不正です。必要なフィールド: fileId=${!!fileId}, slides=${!!slides}`,
  expectedFormat: { fileId: "string", slides: "array" },
  receivedFormat: { fileId: typeof fileId, slides: typeof slides },
  timestamp: new Date().toISOString()
}, { status: 400 });

// クライアント側
if (!response.ok) {
  const errorData = await response.json();
  console.error("詳細なエラー情報:", errorData);
  throw new Error(errorData.details || errorData.error || 'ダウンロードに失敗しました');
}
```

# 今後の実装計画

## 優先度: 最高
1. **PPTXファイル処理エラーの修正**
   - クライアント側とサーバー側のリクエスト形式の不一致を解消
   - ファイルパス管理の一貫性確保
   - エラーハンドリングの強化

2. **ユニットテストの修正**
   - `tests/setup.ts` の構文エラー修正
   - Jest設定の見直し
   - TypeScriptの型定義問題の解決

3. **CI/CD統合**
   - GitHub Actionsでのテスト自動化
   - テスト結果レポートの生成
   - テストカバレッジの計測

4. **テスト実行環境の整備**
   - Docker環境でのE2Eテスト実行設定
   - テスト用の独立したデータベース環境の構築

## 優先度: 高
1. **パフォーマンス最適化**
   - 大きなファイルの処理速度改善
   - 画像処理の最適化
   - クライアント側のレンダリング最適化

2. **翻訳履歴機能の実装**
   - 過去の翻訳履歴の保存
   - 翻訳メモリの活用
   - ユーザー別の翻訳履歴管理

3. **ドキュメント作成**
   - 開発者向けドキュメント
   - APIドキュメント
   - セキュリティドキュメント

## 優先度: 中
1. **バッチ翻訳機能の実装**
   - 複数ファイルの一括翻訳
   - バックグラウンド処理
   - 進捗状況の表示

2. **API連携機能の実装**
   - 外部翻訳APIとの連携
   - WebhookによるイベントトリガーのサポートS
   - APIキー管理

3. **統計・分析機能の実装**
   - 翻訳量の統計
   - 使用頻度の高い単語の分析
   - ユーザー活動の分析

## 優先度: 低
1. **多言語対応の拡充**
   - サポート言語の追加
   - 言語固有の翻訳ルールの実装
   - 多言語UIの改善

2. **カスタムテーマ機能**
   - ユーザー別のテーマ設定
   - カラーパレットのカスタマイズ
   - テーマの保存と共有

## UI/UX改善
- [ ] ダークモードの実装
- [ ] レスポンシブデザインの改善
- [ ] アクセシビリティの向上
- [ ] 多言語対応の拡充

## フロントエンド機能改善
- [x] ファイルアップロード機能の強化
  - [x] ドラッグ＆ドロップサポート
  - [x] ファイル形式バリデーション
  - [x] ファイルサイズ制限
  - [x] アップロード進捗表示
  - [x] エラーハンドリング
- [ ] 翻訳プレビュー機能の改善
- [ ] バッチ処理機能の実装
- [ ] エクスポート機能の拡充

## テスト改善計画

### 優先度: 高
1. **UIコンポーネントテストの拡充**
   - [x] 共通コンポーネント（Button, Input, Modal）のテスト追加
   - [ ] フォームコンポーネントのバリデーションテスト
   - [x] インタラクティブなコンポーネント（DropdownMenu）のテスト追加
   - [ ] 状態管理を含むコンポーネントのテスト

2. **APIエンドポイントテストの完全カバレッジ**
   - [x] 認証関連エンドポイント（ログインAPI）のテスト追加
   - [ ] ファイル操作エンドポイントのテスト強化
   - [ ] エラーハンドリングのテストケース追加
   - [ ] レート制限機能のテスト

3. **ユーティリティ関数のテスト強化**
   - [x] file-utils.tsの残りのメソッドのテスト追加
   - [x] 日付処理関数（formatDate）のテスト追加
   - [x] フォーマット関数（cn）のテスト追加
   - [ ] バリデーション関数の境界値テスト

### 優先度: 中
1. **ページコンポーネントテスト**
   - [ ] 各ページのレンダリングテスト
   - [ ] ページ遷移のテスト
   - [ ] データフェッチングを含むページのテスト
   - [ ] エラー状態のテスト

2. **レイアウトコンポーネントテスト**
   - [ ] 共通レイアウトのレンダリングテスト
   - [ ] レスポンシブ対応のテスト
   - [ ] ナビゲーション要素のテスト
   - [ ] コンテキストプロバイダーのテスト

3. **統合テストの拡充**
   - [ ] 複数コンポーネント間の連携テスト
   - [ ] フォーム送信からAPIレスポンスまでの一連のフローテスト
   - [ ] 認証フローの統合テスト
   - [ ] ファイル処理の統合テスト

### 優先度: 低
1. **E2Eテストシナリオの追加**
   - [ ] ユーザー登録から翻訳完了までの一連のフローテスト
   - [ ] エラー発生時のリカバリーフローテスト
   - [ ] 複数ファイル処理のテスト
   - [ ] 長時間操作のテスト

2. **パフォーマンステスト**
   - [ ] コンポーネントレンダリングのパフォーマンステスト
   - [ ] 大量データ処理時のパフォーマンステスト
   - [ ] API応答時間のテスト
   - [ ] メモリ使用量のテスト

3. **アクセシビリティテスト**
   - [ ] スクリーンリーダー対応テスト
   - [ ] キーボードナビゲーションテスト
   - [ ] コントラスト比テスト
   - [ ] フォーカス管理テスト