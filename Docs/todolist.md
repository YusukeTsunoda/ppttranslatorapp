# Python実装とDockerによるVercelデプロイ計画

## 目標
現在のNext.jsアプリケーションをPythonで実装し、Dockerコンテナ化してVercelにデプロイする

## 実装手順

### 1. Pythonバックエンドの構築
- [x] FastAPIフレームワークを使用したバックエンドの構築
- [x] 必要なPythonパッケージの整理とrequirements.txtの作成
- [x] PPTXパーサー機能のPython実装への移行
- [x] PPTXジェネレーター機能のPython実装への移行
- [x] 認証機能のPython実装への移行
- [x] ファイルアップロード/ダウンロード機能の実装
- [x] エラーハンドリングの実装

### 2. Dockerコンテナ化
- [x] Dockerfileの作成
- [x] docker-compose.ymlの更新
- [x] 開発環境用のコンテナ設定
- [x] 本番環境用のコンテナ設定
- [x] 環境変数の管理方法の整備

### 3. フロントエンドとの連携
- [x] APIエンドポイントの整備
- [x] CORS設定の実装
- [x] フロントエンドからのAPI呼び出し方法の調整
- [x] 認証トークンの受け渡し方法の実装

### 4. Vercelデプロイ準備
- [x] Vercel.jsonの更新
- [x] Serverless Functionsの設定
- [x] 環境変数の設定
- [x] ビルドスクリプトの調整

### 5. デプロイとテスト
- [x] ローカル環境でのテスト
- [x] Vercelへのデプロイ
- [x] デプロイ後の動作確認
- [x] パフォーマンステスト

## 技術スタック
- バックエンド: Python 3.9+, FastAPI
- コンテナ化: Docker, docker-compose
- デプロイ: Vercel
- 依存パッケージ: python-pptx, Pillow, pdf2image

## デプロイ手順

1. リポジトリをクローン
```bash
git clone <repository-url>
cd ppttranslatorapp
```

2. Dockerイメージをビルド
```bash
cd python_backend
docker build -t ppt-translator-api .
```

3. ローカルでテスト実行
```bash
docker run -p 3000:3000 ppt-translator-api
```

4. Vercelにデプロイ
```bash
vercel
```

5. 環境変数の設定
Vercelダッシュボードで以下の環境変数を設定:
- `PORT`: 3000
- `ALLOWED_ORIGINS`: フロントエンドのURL（カンマ区切りで複数指定可能）

---

# タスクリスト（2025年4月12日更新）

## 解決済みの問題
- [x] モジュール形式の問題
  - [x] ES Modules (ESM) と CommonJS の混在による問題を解決
  - [x] すべての設定ファイルをCommonJS形式に統一（.js拡張子）
  - [x] package.jsonから "type": "module" を削除
  - [x] Jest、Babel、Next.js、Cypressの設定ファイルを修正

## 優先度: 高
- [x] 翻訳履歴機能の拡張（API/UI/新フィールド表示まで完了）
  - [x] Prismaスキーマ修正・マイグレーション（fileSize, processingTime, thumbnailPath, tags, metadata追加）
  - [x] /api/history のAPI拡張（フィルタ・ソート・ページネーション対応、新フィールド返却）
  - [x] /api/history/[id] の詳細API新規作成・新フィールド返却
  - [x] 履歴一覧UIの改善（サムネイル・ファイルサイズ・クレジット・言語ペア・処理日時・レスポンシブ・ページネーション）
  - [x] 詳細表示機能の追加（動的ルーティングorモーダル、スライドプレビュー、メタデータ表示、再翻訳・エクスポート）
  - [x] フィルタリング・ソート機能の実装（パネル・日付・検索・言語・ステータス・ソートドロップダウン・昇降順切替・URL連携）
- [x] パフォーマンス最適化（着手・一部完了）
  - [x] PPTXファイル処理の速度・メモリ効率改善（API/フロント）
  - [x] サムネイル画像遅延ロードAPI設計・実装（着手・一部完了）
  - [x] 履歴APIのクエリパラメータ対応（着手・一部完了）
  - [x] クライアントキャッシュ戦略（SWR/react-query等）設計・導入（着手・一部完了）
- [x] 翻訳テキストの位置ずれ修正
  - [x] PPTX生成時のテキストボックス位置・サイズ・フォント・autofit等の再計算・調整
  - [x] フォント差異や環境差異への対応
- [x] テストカバレッジ向上（着手・一部完了）
  - [x] API・UIコンポーネントのユニット/結合/E2Eテスト追加
  - [x] テストカバレッジ拡充（カバレッジレポートを見て未カバー箇所を優先的に追加、進行中）

## 解決済み（完了済み）
- [x] モジュール形式の問題
  - [x] ES Modules (ESM) と CommonJS の混在による問題を解決
  - [x] すべての設定ファイルをCommonJS形式に統一（.js拡張子）
  - [x] package.jsonから "type": "module" を削除
  - [x] Jest、Babel、Next.js、Cypressの設定ファイルを修正

## 優先度: 中

### バッチ翻訳機能
- [x] バッチアップロードAPI（/api/batch-upload）雛形→本実装（Node.js API Routeでmultipart対応予定）
- [x] バッチワーカー（scripts/batch_worker.ts）雛形→ts-node/tsxで起動・DB連携OK
- [x] 進捗API（GET /api/batch-upload?jobId=xxx）で進捗・エラー取得OK
- [ ] multipart/form-dataパース（formidable等）でpptxファイル受信・保存・DB登録（実装中）
- [ ] E2E検証（curlでアップロード→jobId取得→GETで進捗確認）
- [ ] 進捗API/UIのE2E検証

### APIキー外部連携
- [ ] 外部サービス連携用APIキー発行・管理API（設計中）
- [ ] 例: Google, DeepL, Azure等の外部翻訳API連携

### 請求書メール送信
- [ ] Resend連携・請求書PDFメール送信API（設計中）

### 統計データエクスポート
- [ ] CSV/ExcelエクスポートAPI（設計中）

### RLS/監査ログ
- [ ] Supabase等のRLSポリシー・監査ログ自動記録API（設計中）

---

#### 【現状の課題・次アクション】
- multipart/form-dataのパース・保存・DB登録をformidable等で実装
- E2E検証（curl→jobId→進捗GET）
- 未実装タスク（APIキー外部連携・請求書メール送信・統計エクスポート・RLS/監査ログ）の自動実装

## 優先度: 低
- [ ] ブログ機能の実装
  - [ ] 記事投稿システム
  - [ ] カテゴリ管理
  - [ ] コメント機能
- [ ] 多言語対応の拡充
  - [ ] 新しい言語ペアの追加
  - [ ] 言語固有の処理の最適化
  - [ ] 翻訳品質の向上
- [ ] カスタムテーマ機能
  - [ ] テーマエディタ
  - [ ] プリセットテーマ
  - [ ] テーマの共有機能
- [ ] APIドキュメントの整備
  - [ ] Swagger/OpenAPIの導入
  - [ ] エンドポイントの詳細説明
  - [ ] サンプルコード

## E2Eテスト改善計画（2025年4月12日更新）

### 実装済み
- [x] 認証テストの実装
  - [x] テスト用のユーザーアカウント設定
  - [x] 認証情報の環境変数化
  - [x] サインイン後のリダイレクト問題の解決
  - [x] エラーメッセージ検証の改善
  - [x] 実際のUIテキストとテスト期待値の同期
  - [x] サインインエラー要素のdata-testid属性の追加
  - [x] 認証フローのリダイレクト問題の調査と修正
- [x] テストデータの準備
  - [x] サンプルPPTXファイルの作成
  - [x] テスト用データベースシードスクリプトの実装
  - [x] テスト環境のリセット機能
  - [x] 有効なPPTXテストファイルの作成（実際のスライドとテキストを含む）
  - [x] テストデータの自動生成スクリプトの実装
- [x] テスト環境の安定化
  - [x] タイムアウト値の最適化
  - [x] 非同期処理の待機時間調整
  - [x] テスト実行の並列化設定
  - [x] ポート番号の一貫性確保（3000, 3001, 3002の混在問題）
  - [x] テスト実行前のアプリケーション状態リセット機能
  - [x] ネットワークリクエストの待機戦略の改善
- [x] UI要素の識別子追加
  - [x] 残りのコンポーネントにdata-testid属性を追加
  - [x] テスト用のセレクタ定義の統一
  - [x] アクセシビリティ属性の活用
  - [x] サインインフォームの各要素にdata-testid追加
  - [x] 翻訳ページの各UI要素にdata-testid追加
  - [x] エラーメッセージ表示要素にdata-testid追加
- [x] 段階的テスト実装
  - [x] 認証フローテストの完成
  - [x] ファイルアップロードテストの実装
  - [x] 翻訳処理テストの実装
  - [x] ダウンロードテストの実装
  - [x] 各テストケースの独立性確保（テスト間の依存関係排除）
  - [x] 失敗時のリトライ戦略の改善
- [x] テスト実行環境の改善
  - [x] Cypressの設定ファイルをCommonJS形式に変更（cypress.config.js）
  - [x] サポートファイルをCommonJS形式に変更（e2e.js）
  - [x] テスト実行スクリプトの最適化
  - [x] テストレポート生成機能の追加（mochawesome）
  - [x] ポート設定の修正（3000に統一）

### 次に実装すべき項目
1. **CI/CD統合**
   - [ ] GitHub Actionsでのテスト自動化
   - [ ] テスト結果レポートの生成
   - [ ] テストカバレッジの計測
   - [ ] テスト失敗時のスクリーンショット保存と分析
   - [ ] テスト実行時間の最適化

2. **テスト実行環境の整備**
   - [ ] Docker環境でのE2Eテスト実行設定
   - [ ] テスト用の独立したデータベース環境の構築
   - [ ] 本番環境に影響を与えないテスト実行の仕組み
   - [ ] テスト実行のログ収集と分析機能

3. **テストコードの品質向上**
   - [ ] テストコードのリファクタリング
   - [ ] 共通処理のユーティリティ関数化
   - [ ] テストケースのドキュメント化
   - [ ] テストコードのレビュープロセス確立

4. **テストケースの拡充**
   - [ ] プロフィール編集機能のテスト
   - [ ] 設定変更機能のテスト
   - [ ] エラー状態のテスト
   - [ ] 境界値テスト
   - [ ] パフォーマンステスト

5. **モバイル対応テスト**
   - [ ] レスポンシブデザインのテスト
   - [ ] タッチ操作のテスト
   - [ ] モバイル特有の問題の検出

## PPTXファイル処理エラー修正計画（2025年4月12日更新）

### 解決済みの問題
- [x] クライアントとサーバー間のリクエストデータの不一致
  - [x] APIエンドポイントの期待値と実際の送信データの調整
  - [x] ファイルパスの正しい管理と受け渡し
  - [x] エラーハンドリングの改善

### 次に修正すべき問題
1. **ファイルパス管理の最適化**
   - [ ] ファイルパス管理を一元化するユーティリティの作成
   - [ ] 一時ファイルの適切なクリーンアップ処理
   - [ ] ファイル名の一貫性と重複防止

2. **PPTXパーサーの安定性向上**
   - [ ] 大きなファイル処理時のメモリ最適化
   - [ ] エラーハンドリングの強化とリトライメカニズム
   - [ ] 複雑なフォーマットへの対応強化

3. **テキスト位置の正確な保持**
   - [ ] 座標変換アルゴリズムの精度向上
   - [ ] フォントサイズと行間の自動調整
   - [ ] 言語固有のレイアウト調整

## Supabase連携計画
### Phase 1: 基本設定とデータベース移行
- [ ] Supabase プロジェクトのセットアップ
  - [ ] プロジェクト作成
  - [ ] 環境変数の設定
  - [ ] Vercelとの連携設定
- [ ] データベーススキーマの移行
  - [ ] テーブル構造の移行
  - [ ] インデックスの設定
  - [ ] 外部キー制約の設定
- [ ] 認証システムの連携
  - [ ] NextAuthとSupabaseAuthの統合
  - [ ] ユーザーデータの移行
  - [ ] 認証フローのテスト

### Phase 2: ストレージとRLS実装
- [ ] ファイルストレージの設定
  - [ ] バケット構造の設計
  - [ ] アクセス制御の設定
  - [ ] ファイル移行スクリプトの作成
- [ ] RLSポリシーの実装
  - [ ] テーブルごとのポリシー設定
  - [ ] ロールベースのアクセス制御
  - [ ] ポリシーのテスト

### Phase 3: リアルタイム機能と最適化
- [ ] リアルタイム更新の実装
  - [ ] サブスクリプション設定
  - [ ] フロントエンドの連携
  - [ ] パフォーマンステスト
- [ ] エッジ関数の活用
  - [ ] 認証関連処理の移行
  - [ ] ファイル処理の最適化
  - [ ] CDN設定の最適化

# 今後の実装計画（2025年4月12日更新）

## 優先度: 最高
1. **GitHub Actions CI/CD構築**
   - [ ] テスト自動実行ワークフロー作成
   - [ ] ビルド＆デプロイ自動化
   - [ ] コードチェック・リンター連携
   - [ ] テストレポート自動生成
   - [ ] Slackへの通知連携

2. **Pythonバックエンドとの連携強化**
   - [ ] API応答形式の標準化
   - [ ] エラーハンドリングの統一
   - [ ] 認証トークンの受け渡し
   - [ ] ファイル処理の並列化

3. **PPTXプレビュー機能の改善**
   - [ ] プレビュー表示の精度向上
   - [ ] 編集中テキストのリアルタイムプレビュー
   - [ ] スライドナビゲーションの改善
   - [ ] ズーム機能の追加

## 優先度: 高
1. **パフォーマンス最適化**
   - [ ] SSRとCSRの適切な使い分け
   - [ ] 画像最適化
   - [ ] コンポーネントの遅延ロード
   - [ ] API応答のキャッシュ戦略

2. **翻訳履歴機能の実装**
   - [ ] 履歴保存機能の実装
   - [ ] 履歴一覧表示
   - [ ] 過去の翻訳の再利用機能
   - [ ] 翻訳メモリの構築

3. **ドキュメント作成**
   - [ ] API仕様書
   - [ ] 開発者向けセットアップガイド
   - [ ] コントリビューションガイドライン
   - [ ] セキュリティポリシー

## 優先度: 中
1. **バッチ処理機能の実装**
   - [ ] 複数ファイルの一括処理
   - [ ] バックグラウンド処理
   - [ ] 進捗表示
   - [ ] 処理結果のレポート

2. **UI/UX改善**
   - [ ] ダークモード実装
   - [ ] モバイル対応強化
   - [ ] アクセシビリティ改善
   - [ ] 多言語UI対応

3. **エラー監視とログ分析**
   - [ ] エラー通知システム
   - [ ] ユーザー行動分析
   - [ ] パフォーマンスモニタリング
   - [ ] セキュリティ監視

## UI/UX改善
- [ ] ダークモードの実装
- [ ] レスポンシブデザインの改善
- [ ] アクセシビリティの向上
- [ ] 多言語対応の拡充

## フロントエンド機能改善
- [x] ファイルアップロード機能の強化
  - [x] ドラッグ＆ドロップサポート
  - [x] ファイル形式バリデーション
  - [x] ファイルサイズ制限
  - [x] アップロード進捗表示
  - [x] エラーハンドリング
- [ ] 翻訳プレビュー機能の改善
- [ ] バッチ処理機能の実装
- [ ] エクスポート機能の拡充

## テスト改善計画

### 優先度: 高
1. **UIコンポーネントテストの拡充**
   - [x] 共通コンポーネント（Button, Input, Modal）のテスト追加
   - [ ] フォームコンポーネントのバリデーションテスト
   - [x] インタラクティブなコンポーネント（DropdownMenu）のテスト追加
   - [ ] 状態管理を含むコンポーネントのテスト

2. **APIエンドポイントテストの完全カバレッジ**
   - [x] 認証関連エンドポイント（ログインAPI）のテスト追加
   - [ ] ファイル操作エンドポイントのテスト強化
   - [ ] エラーハンドリングのテストケース追加
   - [ ] レート制限機能のテスト

3. **ユーティリティ関数のテスト強化**
   - [x] file-utils.tsの残りのメソッドのテスト追加
   - [x] 日付処理関数（formatDate）のテスト追加
   - [x] フォーマット関数（cn）のテスト追加
   - [x] バリデーション関数の境界値テスト

4. **テスト環境の整備**
   - [x] Jest設定をCommonJS形式に対応
   - [x] テスト実行スクリプトの最適化
   - [x] ESLint設定の修正
   - [x] TypeScriptの型定義問題の解決
   - [x] テスト実行時の警告解消

### 優先度: 中
1. **ページコンポーネントテスト**
   - [ ] 各ページのレンダリングテスト
   - [ ] ページ遷移のテスト
   - [ ] データフェッチングを含むページのテスト
   - [ ] エラー状態のテスト

2. **レイアウトコンポーネントテスト**
   - [ ] 共通レイアウトのレンダリングテスト
   - [ ] レスポンシブ対応のテスト
   - [ ] ナビゲーション要素のテスト
   - [ ] コンテキストプロバイダーのテスト

3. **統合テストの拡充**
   - [ ] 複数コンポーネント間の連携テスト
   - [ ] フォーム送信からAPIレスポンスまでの一連のフローテスト
   - [ ] 認証フローの統合テスト
   - [ ] ファイル処理の統合テスト

### 優先度: 低
1. **E2Eテストシナリオの追加**
   - [x] ユーザー登録から翻訳完了までの一連のフローテスト
   - [ ] エラー発生時のリカバリーフローテスト
   - [ ] 複数ファイル処理のテスト
   - [ ] 長時間操作のテスト

2. **パフォーマンステスト**
   - [ ] コンポーネントレンダリングのパフォーマンステスト
   - [ ] 大量データ処理時のパフォーマンステスト
   - [ ] API応答時間のテスト
   - [ ] メモリ使用量のテスト

3. **アクセシビリティテスト**
   - [ ] スクリーンリーダー対応テスト
   - [ ] キーボードナビゲーションテスト
   - [ ] コントラスト比テスト
   - [ ] フォーカス管理テスト

# ファイル拡張子の一貫性確保

## 背景
- package.jsonで`"type": "module"`を設定していても、CommonJS形式のファイルを使用する必要がある
- `.js`、`.mjs`、`.cjs`拡張子が混在しており、一貫性を持たせる必要がある

## 修正計画
- [x] PostCSSの設定を統一
  - [x] `postcss.config.js`と`postcss.config.mjs`の内容を比較
  - [x] 内容を統合し、`postcss.config.cjs`に変換
  - [x] 既存の設定ファイルを削除
- [x] Tailwindの設定を調整
  - [x] `tailwind.config.js`を`tailwind.config.cjs`に変換
  - [x] 既存の設定ファイルを削除
- [x] Cypressの設定を調整
  - [x] `cypress.config.js`を`cypress.config.cjs`に変換
  - [x] 既存の設定ファイルを削除
- [x] package.jsonのスクリプト内で参照しているパスを更新
  - [x] Cypressスクリプトの設定ファイル参照パスを.cjsに更新
- [x] CI/CDパイプラインでの参照を確認・修正
  - [x] .github/workflows/ci-cd.ymlでの参照を確認

### 実装順序
1. [x] PostCSS設定の統一（影響範囲が限られているため）
2. [x] Tailwindの設定調整
3. [x] Cypressの設定調整
4. [x] その他必要な参照更新

### 注意点
- [x] 変更は独立して行い、各変更後に動作確認をする
- [x] 変更理由を文書化し、将来の開発者のための注釈を追加する
- [x] eslint.config.jsは新しいフラット設定形式を使用していて、ESMを使用しているため、.js拡張子のままとする