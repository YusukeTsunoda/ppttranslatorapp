# PPT翻訳アプリケーション タスクリスト (2025年6月更新)

## 完了済みタスク ✅

### Python実装とDockerによるVercelデプロイ計画
- [x] FastAPIフレームワークを使用したバックエンドの構築
- [x] 必要なPythonパッケージの整理とrequirements.txtの作成
- [x] PPTXパーサー機能のPython実装への移行
- [x] PPTXジェネレーター機能のPython実装への移行
- [x] 認証機能のPython実装への移行
- [x] ファイルアップロード/ダウンロード機能の実装
- [x] エラーハンドリングの実装
- [x] Dockerfileの作成
- [x] docker-compose.ymlの更新
- [x] 開発環境用のコンテナ設定
- [x] 本番環境用のコンテナ設定
- [x] 環境変数の管理方法の整備
- [x] APIエンドポイントの整備
- [x] CORS設定の実装
- [x] フロントエンドからのAPI呼び出し方法の調整
- [x] 認証トークンの受け渡し方法の実装
- [x] Vercel.jsonの更新
- [x] Serverless Functionsの設定
- [x] 環境変数の設定
- [x] ビルドスクリプトの調整
- [x] ローカル環境でのテスト
- [x] Vercelへのデプロイ
- [x] デプロイ後の動作確認
- [x] パフォーマンステスト

### 設定ファイルのCommonJS形式への統一と各種調整
- [x] PostCSSの設定を統一
  - [x] `postcss.config.js`と`postcss.config.mjs`の内容を比較
  - [x] 内容を統合し、`postcss.config.cjs`に変換
  - [x] 既存の設定ファイルを削除
- [x] Tailwindの設定を調整
  - [x] `tailwind.config.js`を`tailwind.config.cjs`に変換
  - [x] 既存の設定ファイルを削除
- [x] Cypressの設定を調整
  - [x] `cypress.config.js`を`cypress.config.cjs`に変換
  - [x] 既存の設定ファイルを削除
- [x] package.jsonのスクリプト内で参照しているパスを更新
  - [x] Cypressスクリプトの設定ファイル参照パスを.cjsに更新
- [x] CI/CDパイプラインでの参照を確認・修正
  - [x] .github/workflows/ci-cd.ymlでの参照を確認
- [x] 変更は独立して行い、各変更後に動作確認をする
- [x] 変更理由を文書化し、将来の開発者のための注釈を追加する
- [x] eslint.config.jsは新しいフラット設定形式を使用していて、ESMを使用しているため、.js拡張子のままとする

### APIとUIの改善
- [x] APIルーティングのビルド状況ログ確認
  - [x] `lib/utils/api-logging.ts`作成
  - [x] ログ関連ドキュメント追加
- [x] API競合解消のためのRoute Handler移行
  - [x] バッチアップロードAPIとAPIキー関連のルートを更新
- [x] バッチワーカーのTSX統一（React Inkを使用したTUIツール）
  - [x] バッチワーカー関連スクリプトをTSXに統一
- [x] formidable型定義の整備
  - [x] 型定義ファイル追加とアップロードヘルパー更新
- [x] UI・パフォーマンス改善
  - [x] LazyImageコンポーネント作成（画像の遅延ロード） (components/ui/lazy-image.tsx, enhanced-lazy-image.tsxで実装済み)
  - [x] useQueryCacheフック実装（APIクエリ結果のキャッシング） (lib/hooks/useQueryCache.tsで実装済み)
  - [x] フォントマッピングとテキストレイアウト調整の実装 (lib/pptx/textLayout.tsで実装済み)
- [x] フォントマッピングユーティリティ作成
- [x] テキストレイアウト調整ヘルパー関数

### モジュール形式の問題解決
- [x] ES Modules (ESM) と CommonJS の混在による問題を解決
- [x] すべての設定ファイルをCommonJS形式に統一（.js拡張子）
- [x] package.jsonから "type": "module" を削除
- [x] Jest、Babel、Next.js、Cypressの設定ファイルを修正

### 翻訳履歴機能の拡張
- [x] Prismaスキーマ修正・マイグレーション（fileSize, processingTime, thumbnailPath, tags, metadata追加） ✓
- [x] /api/history のAPI拡張（フィルタ・ソート・ページネーション対応、新フィールド返却） ✓
- [x] /api/history/[id] の詳細API新規作成・新フィールド返却 ✓
- [x] 履歴一覧UIの改善（サムネイル・ファイルサイズ・クレジット・言語ペア・処理日時・レスポンシブ・ページネーション） ✓
- [x] 詳細表示機能の追加（動的ルーティングorモーダル、スライドプレビュー、メタデータ表示、再翻訳・エクスポート） ✓
- [x] フィルタリング・ソート機能の実装（パネル・日付・検索・言語・ステータス・ソートドロップダウン・昇降順切替・URL連携） ✓

### テスト関連
- [x] 認証テストの実装
  - [x] テスト用のユーザーアカウント設定
  - [x] 認証情報の環境変数化
  - [x] サインイン後のリダイレクト問題の解決
  - [x] エラーメッセージ検証の改善
  - [x] 実際のUIテキストとテスト期待値の同期
  - [x] サインインエラー要素のdata-testid属性の追加
  - [x] 認証フローのリダイレクト問題の調査と修正
- [x] テストデータの準備
  - [x] サンプルPPTXファイルの作成
  - [x] テスト用データベースシードスクリプトの実装
  - [x] テスト環境のリセット機能
  - [x] 有効なPPTXテストファイルの作成（実際のスライドとテキストを含む）
  - [x] テストデータの自動生成スクリプトの実装
- [x] テスト環境の安定化
  - [x] タイムアウト値の最適化
  - [x] 非同期処理の待機時間調整
  - [x] テスト実行の並列化設定
  - [x] ポート番号の一貫性確保（3000, 3001, 3002の混在問題）
  - [x] テスト実行前のアプリケーション状態リセット機能
  - [x] ネットワークリクエストの待機戦略の改善
- [x] UI要素の識別子追加
  - [x] 残りのコンポーネントにdata-testid属性を追加
  - [x] テスト用のセレクタ定義の統一
  - [x] アクセシビリティ属性の活用
  - [x] サインインフォームの各要素にdata-testid追加
  - [x] 翻訳ページの各UI要素にdata-testid追加
  - [x] エラーメッセージ表示要素にdata-testid追加
- [x] 段階的テスト実装
  - [x] 認証フローテストの完成
  - [x] ファイルアップロードテストの実装
  - [x] 翻訳処理テストの実装
  - [x] ダウンロードテストの実装
  - [x] 各テストケースの独立性確保（テスト間の依存関係排除）
  - [x] 失敗時のリトライ戦略の改善
- [x] テスト実行環境の改善
  - [x] Cypressの設定ファイルをCommonJS形式に変更（cypress.config.js）
  - [x] サポートファイルをCommonJS形式に変更（e2e.js）
  - [x] テスト実行スクリプトの最適化
  - [x] テストレポート生成機能の追加（mochawesome）
  - [x] ポート設定の修正（3000に統一）
- [x] UIコンポーネントのユニットテスト追加（Dialog, Textarea, Separator, Skeleton） ✓ (components/ui/のテスト実装済み)
- [x] ユーティリティ関数のテスト追加（activity-logger, file-utils） ✓ (テスト実装済み)
- [x] API関連テスト追加（history API） ✓ (テスト実装済み)
- [x] フックテスト追加（useApi, useIntersectionObserver） ✓ (lib/hooks/のテスト実装済み)

### ファイルアップロード機能
- [x] ドラッグ＆ドロップサポート
- [x] ファイル形式バリデーション
- [x] ファイルサイズ制限
- [x] アップロード進捗表示
- [x] エラーハンドリング

### PPTXファイル処理エラー修正
- [x] クライアントとサーバー間のリクエストデータの不一致
  - [x] APIエンドポイントの期待値と実際の送信データの調整
  - [x] ファイルパスの正しい管理と受け渡し
  - [x] エラーハンドリングの改善

## 実装中のタスク 🔄

### パフォーマンス最適化（`feature/performance-optimization`ブランチ）
- [ ] PPTXパーサーの最適化（進行中）
- [ ] スライドAPIの改善（進行中）
- [ ] クエリパラメータによるサーバーサイドフィルタリング

### 翻訳テキストの位置ずれ修正（`fix/text-position-alignment`ブランチ）
- [ ] PPTX生成時のテキストボックス位置・サイズ・フォント・autofit等の再計算・調整
- [ ] PPTXジェネレーターの修正（進行中）

### テストカバレッジ向上（`feature/test-coverage-improvement`ブランチ）
- [x] SWCの設定最適化
  - [x] TypeScriptサポートの強化
  - [x] デコレータとダイナミックインポートのサポート追加
  - [x] ソースマップサポートの追加
- [x] Jestの設定改善
  - [x] モジュールマッピングの最適化
  - [x] カバレッジレポート設定の調整
  - [x] テストタイムアウト設定の最適化
- [x] テスト実行スクリプトの整備
  - [x] カバレッジレポート生成の最適化
  - [x] CI/CD用のテスト実行コマンド追加

### テストインフラストラクチャの改善（優先度：最高）
- [x] テストデータ管理の整備
  - [x] テストデータファクトリーの実装
    - [x] ユーザーデータファクトリー
    - [x] 翻訳履歴データファクトリー
    - [x] クレジットログファクトリー
    - [x] アクティビティログファクトリー
  - [x] テスト用DBセットアップの自動化
    - [x] マイグレーションスクリプトの最適化
    - [x] シードデータの自動投入
    - [x] テスト後のクリーンアップ処理
  - [x] モックデータの整備
    - [x] PPTXファイルのモックデータ
    - [x] APIレスポンスのモックデータ
    - [x] 外部サービス連携のモックデータ

### 次のステップ：テストケース実装（優先度：高）
- [ ] ファクトリーを使用したテストケースの実装
  - [ ] ユーザー管理APIテスト
    - [ ] ユーザー作成テスト
    - [ ] ユーザー更新テスト
    - [ ] ユーザー削除テスト
  - [ ] 翻訳履歴APIテスト
    - [ ] 履歴作成テスト
    - [ ] 履歴一覧取得テスト
    - [ ] 履歴詳細取得テスト
  - [ ] クレジット管理APIテスト
    - [ ] クレジット付与テスト
    - [ ] クレジット消費テスト
    - [ ] クレジット履歴テスト
  - [ ] アクティビティログAPIテスト
    - [ ] ログ記録テスト
    - [ ] ログ取得テスト
    - [ ] ログフィルタリングテスト

### CI/CD環境の整備（優先度：高）
- [ ] テストデータベース環境の構築
  - [ ] テスト用PostgreSQLコンテナの設定
  - [ ] 環境変数の設定
  - [ ] マイグレーション自動実行の設定
- [ ] テスト実行の自動化
  - [ ] GitHub Actionsワークフローの設定
  - [ ] テストレポート生成の設定
  - [ ] カバレッジレポートの設定
- [ ] テスト実行の最適化
  - [ ] 並列実行の設定
  - [ ] キャッシュの活用
  - [ ] テスト実行時間の短縮

### 実装スケジュール
1. テストケース実装（2週間）
   - Week 1: 基本的なCRUD操作のテスト実装
   - Week 2: 複雑なビジネスロジックのテスト実装

2. CI/CD環境整備（1週間）
   - Day 1-2: テストデータベース環境の構築
   - Day 3-4: GitHub Actionsの設定
   - Day 5: テスト実行の最適化

### 注意点と課題
1. テストの独立性確保
   - 各テストケース間でのデータ競合の防止
   - テストデータのクリーンアップ確実な実行

2. テストパフォーマンス
   - 不要なデータベースアクセスの削減
   - モックの適切な使用

3. メンテナンス性
   - テストコードの可読性維持
   - 共通処理の適切な抽象化
   - ドキュメントの整備

### ファイルアップロード機能
- [x] ドラッグ＆ドロップサポート
- [x] ファイル形式バリデーション
- [x] ファイルサイズ制限
- [x] アップロード進捗表示
- [x] エラーハンドリング

### PPTXファイル処理エラー修正
- [x] クライアントとサーバー間のリクエストデータの不一致
  - [x] APIエンドポイントの期待値と実際の送信データの調整
  - [x] ファイルパスの正しい管理と受け渡し
  - [x] エラーハンドリングの改善

## 今後のタスク（優先度順）📋

### 優先度：最高
- [ ] PPTXファイル処理の速度・メモリ効率改善（API/フロント）
- [ ] CI/CD統合
  - [x] テスト実行環境の整備
    - [x] Jest設定の最適化
    - [x] Cypress設定の最適化
    - [x] テストレポート生成の設定
  - [x] テストスクリプトの整備
    - [x] ユニットテスト実行コマンド
    - [x] E2Eテスト実行コマンド
    - [x] カバレッジレポート生成コマンド
  - [ ] GitHub Actionsワークフロー設定（進行中）
    - [x] プレビューデプロイの自動化
      - [x] Vercel CLIを使用したデプロイスクリプト
      - [x] デプロイURLのPRコメント自動投稿
      - [x] Slack通知の設定
    - [ ] テスト自動化の実装（次のステップ）
      - [ ] ユニットテストワークフロー
        - [ ] Jest実行設定
        - [ ] カバレッジレポート生成
        - [ ] テスト結果のGitHubへの自動コメント
        - [ ] カバレッジバッジの生成と更新
      - [ ] E2Eテストワークフロー
        - [ ] Cypressテスト実行環境の構築
        - [ ] テスト実行タイミングの最適化
        - [ ] スクリーンショットとビデオの保存設定
        - [ ] テスト失敗時のデバッグ情報収集
      - [ ] コード品質チェックの導入（優先度：高）
        - [ ] ESLint実行設定
          - [ ] カスタムルールの定義
          - [ ] 自動修正の設定
          - [ ] PRレビューコメントの自動化
        - [ ] Prettier実行設定
          - [ ] フォーマット設定の統一
          - [ ] 自動フォーマット処理の追加
        - [ ] TypeScript型チェック
          - [ ] 厳格な型チェックの有効化
          - [ ] 型エラーの自動報告
        - [ ] パフォーマンスチェック
          - [ ] バンドルサイズの分析
          - [ ] パフォーマンスメトリクスの計測
          - [ ] 閾値の設定と監視
      - [ ] ステージング環境の設定準備
        - [ ] Vercel Stagingプロジェクトの作成
          - [ ] プロジェクト設定の複製
          - [ ] 環境変数の設定
          - [ ] デプロイメントドメインの設定
        - [ ] デプロイメントワークフロー
          - [ ] mainブランチへのマージ時の自動デプロイ
          - [ ] デプロイ前の検証プロセス
            - [ ] 全テストの実行
            - [ ] コード品質チェック
            - [ ] セキュリティスキャン
          - [ ] デプロイ後のヘルスチェック
            - [ ] エンドポイントの死活監視
            - [ ] エラーレートの監視
            - [ ] パフォーマンスメトリクスの収集
        - [ ] データベース環境の準備
          - [ ] ステージング用DBの作成
          - [ ] マイグレーションの自動実行
          - [ ] テストデータの準備
        - [ ] モニタリングの設定
          - [ ] ログ収集の設定
          - [ ] アラート閾値の設定
          - [ ] ダッシュボードの作成

実装スケジュール：
1. テスト自動化の実装（2週間）
   - Week 1: ユニットテストワークフローの実装
   - Week 2: E2Eテストワークフローの実装と統合

2. コード品質チェックの導入（1週間）
   - Day 1-2: ESLintとPrettier設定
   - Day 3-4: TypeScript型チェック設定
   - Day 5: パフォーマンスチェック設定

3. ステージング環境の設定（2週間）
   - Week 1: Vercelプロジェクト設定とデプロイメントワークフロー
   - Week 2: データベース環境とモニタリング設定

予想される課題と対策：
1. テスト実行時間の最適化
   - テストの並列実行
   - テストキャッシュの活用
   - 重要度に応じたテストの分類

2. コード品質チェックの基準設定
   - チーム内での基準の合意
   - 段階的な厳格化
   - 自動修正可能なルールの優先適用

3. ステージング環境のデータ管理
   - 本番データの安全な匿名化
   - 定期的なデータリフレッシュ
   - テストデータの自動生成

### 必要な環境変数とGitHub Secrets

#### GitHub Secrets
- `VERCEL_TOKEN`: Vercel APIトークン（デプロイメント用）
- `VERCEL_ORG_ID`: Vercelの組織ID
- `VERCEL_PROJECT_ID`: Vercelのプロジェクトを識別するID
- `SLACK_WEBHOOK_URL`: Slackへの通知用Webhook URL
- `SUPABASE_URL`: SupabaseのプロジェクトURL
- `SUPABASE_ANON_KEY`: Supabaseの匿名キー
- `SUPABASE_SERVICE_ROLE_KEY`: Supabaseのサービスロールキー
- `NEXT_PUBLIC_SUPABASE_URL`: フロントエンド用SupabaseのURL
- `NEXT_PUBLIC_SUPABASE_ANON_KEY`: フロントエンド用Supabaseの匿名キー

#### Vercel環境変数（Development）
- `NODE_ENV=development`
- `NEXT_PUBLIC_APP_URL`: アプリケーションのURL
- `DATABASE_URL`: 開発用データベースのURL
- `NEXTAUTH_URL`: NextAuth.jsの設定URL
- `NEXTAUTH_SECRET`: NextAuth.jsのシークレットキー
- `ANTHROPIC_API_KEY`: Anthropic APIキー
- `STRIPE_SECRET_KEY`: Stripe APIキー（テスト用）
- `STRIPE_WEBHOOK_SECRET`: Stripeウェブフックのシークレット（テスト用）
- `SMTP_HOST`: メール送信用SMTPホスト
- `SMTP_PORT`: SMTPポート
- `SMTP_USER`: SMTPユーザー
- `SMTP_PASSWORD`: SMTPパスワード

#### Vercel環境変数（Staging）
- `NODE_ENV=staging`
- （上記の変数をステージング環境用に設定）

#### Vercel環境変数（Production）
- `NODE_ENV=production`
- （上記の変数を本番環境用に設定）

実装の優先順序：

1. 開発環境の整備（2週間）
   - Vercelプロジェクト設定
   - プレビューデプロイの自動化
   - 基本的なテスト自動化

2. ステージング環境の整備（2週間）
   - Vercelステージングプロジェクト
   - 自動デプロイフロー
   - 基本的なヘルスチェック

3. デプロイ後の検証システム（2週間）
   - ヘルスチェックエンドポイント
   - 基本的な機能テスト
   - 初期メトリクス収集

4. 本番環境の整備（3週間）
   - Vercel本番プロジェクト
   - 完全な自動化デプロイ
   - Supabase連携

5. ロールバックシステム（2週間）
   - 自動ロールバック機能
   - ロールバックスクリプト
   - 手動プロセス

6. 通知システムの完成（1週間）
   - Slack通知の完成
   - ステータスページ
   - 完全な監視体制

予想される課題：
1. 環境間でのデータ整合性の維持
2. デプロイ時のダウンタイムの最小化
3. ロールバック時のデータ整合性確保
4. パフォーマンスメトリクスの適切なしきい値設定

### 優先度：高
- [ ] バッチ翻訳機能の実装
  - [ ] 複数ファイルの一括アップロード
  - [ ] バックグラウンド処理の実装
  - [ ] 進捗状況の表示
- [ ] API連携機能の実装
  - [ ] 外部サービスとの連携インターフェース
  - [ ] APIキー管理
  - [ ] 使用量の監視
- [ ] テスト実行環境の整備
  - [ ] Docker環境でのE2Eテスト実行設定
  - [ ] テスト用の独立したデータベース環境の構築
  - [ ] 本番環境に影響を与えないテスト実行の仕組み
  - [ ] テスト実行のログ収集と分析機能
- [ ] テストコードの品質向上
  - [ ] テストコードのリファクタリング
  - [ ] 共通処理のユーティリティ関数化
  - [ ] テストケースのドキュメント化
  - [ ] テストコードのレビュープロセス確立
- [ ] テストケースの拡充
  - [ ] プロフィール編集機能のテスト
  - [ ] 設定変更機能のテスト
  - [ ] エラー状態のテスト
  - [ ] 境界値テスト
  - [ ] パフォーマンステスト
- [ ] バッチ処理機能の実装完了 (重複の可能性あり、要確認)

### 優先度：中
- [ ] 請求書生成機能の実装
  - [ ] 請求書テンプレートの作成
  - [ ] PDF生成機能
  - [ ] メール送信機能
- [ ] 統計・分析機能の実装
  - [ ] 使用状況ダッシュボード
  - [ ] グラフ表示
  - [ ] エクスポート機能
- [ ] RLS（Row Level Security）の実装
  - [ ] テーブルごとのポリシー設定
  - [ ] ロールベースのアクセス制御
  - [ ] 監査ログの自動記録
- [ ] モバイル対応テスト
  - [ ] レスポンシブデザインのテスト
  - [ ] タッチ操作のテスト
  - [ ] モバイル特有の問題の検出
- [ ] Supabase連携計画
  - [ ] Phase 1: 基本設定とデータベース移行
    - [ ] Supabase プロジェクトのセットアップ
      - [ ] プロジェクト作成
      - [ ] 環境変数の設定
      - [ ] Vercelとの連携設定
    - [ ] データベーススキーマの移行
      - [ ] テーブル構造の移行
      - [ ] インデックスの設定
      - [ ] 外部キー制約の設定
    - [ ] 認証システムの連携
      - [ ] NextAuthとSupabaseAuthの統合
      - [ ] ユーザーデータの移行
      - [ ] 認証フローのテスト
  - [ ] Phase 2: ストレージとRLS実装
    - [ ] ファイルストレージの設定
      - [ ] バケット構造の設計
      - [ ] アクセス制御の設定
      - [ ] ファイル移行スクリプトの作成
    - [ ] RLSポリシーの実装
      - [ ] テーブルごとのポリシー設定
      - [ ] ロールベースのアクセス制御
      - [ ] ポリシーのテスト
  - [ ] Phase 3: リアルタイム機能と最適化
    - [ ] リアルタイム更新の実装
      - [ ] サブスクリプション設定
      - [ ] フロントエンドの連携
      - [ ] パフォーマンステスト
    - [ ] エッジ関数の活用
      - [ ] 認証関連処理の移行
      - [ ] ファイル処理の最適化
      - [ ] CDN設定の最適化

### 優先度：低
- [ ] ブログ機能の実装
  - [ ] 記事投稿システム
  - [ ] カテゴリ管理
  - [ ] コメント機能
- [ ] 多言語対応の拡充
  - [ ] 新しい言語ペアの追加
  - [ ] 言語固有の処理の最適化
  - [ ] 翻訳品質の向上
- [ ] カスタムテーマ機能
  - [ ] テーマエディタ
  - [ ] プリセットテーマ
  - [ ] テーマの共有機能
- [ ] APIドキュメントの整備
  - [ ] Swagger/OpenAPIの導入
  - [ ] エンドポイントの詳細説明
  - [ ] サンプルコード