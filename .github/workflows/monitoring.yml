name: ç›£è¦–ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š

on:
  schedule:
    - cron: '0 */6 * * *'  # 6æ™‚é–“ã”ã¨ã«å®Ÿè¡Œ
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  health-check:
    name: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å¥å…¨æ€§ãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    steps:
      - name: ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
        uses: jtalk/url-health-check-action@v3
        with:
          url: https://ppttranslatorapp-staging.vercel.app/api/health
          max-attempts: 3
          retry-delay: 5s
          retry-all: true
      
      - name: æœ¬ç•ªç’°å¢ƒã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
        uses: jtalk/url-health-check-action@v3
        with:
          url: https://ppttranslatorapp.vercel.app/api/health
          max-attempts: 3
          retry-delay: 5s
          retry-all: true
      
      - name: Slackã«é€šçŸ¥ï¼ˆå¤±æ•—æ™‚ã®ã¿ï¼‰
        if: failure()
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_CHANNEL: alerts
          SLACK_COLOR: danger
          SLACK_TITLE: 'ğŸš¨ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å¤±æ•—'
          SLACK_MESSAGE: 'ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ç·Šæ€¥å¯¾å¿œãŒå¿…è¦ã§ã™ã€‚'
          SLACK_FOOTER: 'PPTXTranslatorç›£è¦–ã‚·ã‚¹ãƒ†ãƒ '

  performance-check:
    name: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    steps:
      - name: Lighthouse CI
        uses: treosh/lighthouse-ci-action@v9
        with:
          urls: |
            https://ppttranslatorapp.vercel.app/
            https://ppttranslatorapp.vercel.app/translate
          budgetPath: ./lighthouse-budget.json
          uploadArtifacts: true
          temporaryPublicStorage: true
        continue-on-error: true
      
      - name: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
        run: |
          echo "## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¬ãƒãƒ¼ãƒˆ" > performance-report.md
          echo "æœ€æ–°ã®Lighthouseã‚¹ã‚³ã‚¢:" >> performance-report.md
          echo "- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹: ${{ steps.lighthouse.outputs.performance-score }}" >> performance-report.md
          echo "- ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£: ${{ steps.lighthouse.outputs.accessibility-score }}" >> performance-report.md
          echo "- ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹: ${{ steps.lighthouse.outputs.best-practices-score }}" >> performance-report.md
          echo "- SEO: ${{ steps.lighthouse.outputs.seo-score }}" >> performance-report.md
        continue-on-error: true
      
      - name: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¬ãƒãƒ¼ãƒˆã‚’Slackã«é€šçŸ¥
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_CHANNEL: performance
          SLACK_COLOR: good
          SLACK_TITLE: 'ğŸ“Š ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¬ãƒãƒ¼ãƒˆ'
          SLACK_MESSAGE: 'ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯ãŒå®Œäº†ã—ã¾ã—ãŸã€‚è©³ç´°ã¯GitHub Actionsã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'
          SLACK_FOOTER: 'PPTXTranslatorç›£è¦–ã‚·ã‚¹ãƒ†ãƒ '
        continue-on-error: true

  error-monitoring:
    name: ã‚¨ãƒ©ãƒ¼ç›£è¦–
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Node.jsã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci
      
      - name: Sentryã‚¨ãƒ©ãƒ¼ãƒ¬ãƒãƒ¼ãƒˆå–å¾—
        run: node scripts/monitoring/get-sentry-errors.js
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
        continue-on-error: true
      
      - name: ã‚¨ãƒ©ãƒ¼ãƒ¬ãƒãƒ¼ãƒˆã‚’Slackã«é€šçŸ¥ï¼ˆé‡å¤§ãªã‚¨ãƒ©ãƒ¼ãŒã‚ã‚‹å ´åˆã®ã¿ï¼‰
        if: env.HAS_CRITICAL_ERRORS == 'true'
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_CHANNEL: alerts
          SLACK_COLOR: danger
          SLACK_TITLE: 'ğŸ”¥ é‡å¤§ãªã‚¨ãƒ©ãƒ¼ã‚’æ¤œå‡º'
          SLACK_MESSAGE: 'éå»24æ™‚é–“ã«é‡å¤§ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚Sentryãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'
          SLACK_FOOTER: 'PPTXTranslatorç›£è¦–ã‚·ã‚¹ãƒ†ãƒ '
